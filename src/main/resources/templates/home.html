<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${#strings.isEmpty(pageTitle) ? '재무 대시보드' : pageTitle}"></title>

    <!-- Bootstrap (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js & Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root {
            --card-radius: 8px;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, .05);
        }

        html, body {
            height: 100dvh;
            overflow: hidden; /* ← window 스크롤 막기 */
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;

            overflow-x: hidden
        }

        header {
            background: #f8f9fa;
            box-sizing: border-box; /* height에 padding 포함 */
            padding: 0 1rem; /* 세로 패딩 제거(가로만 유지) */
            min-height: 80px;
            height: 92px;
        }

        .logo-square img {
            display: block;
        }

        header h1 {
            white-space: nowrap;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        main {
            flex: 1 1 auto;
            min-height: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: stretch
        }

        footer {
            background: #f8f9fa;
            padding: 1rem;
            min-height: 60px;
            text-align: center;
            font-size: .875rem;
            color: #6c757d
        }

        .logo-square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0
        }

        .logo-square img {
            width: 100%;
            height: 100%;
            object-fit: contain
        }

        .body-header {
            background: #f1f3f5;
            padding: .75rem 1rem;
            gap: .75rem
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0
        }

        input[type=number] {
            -moz-appearance: textfield
        }

        .content-container {
            width: 100%;
            min-height: 0;
            max-height: none;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: var(--card-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            background: #fff;
            box-shadow: var(--shadow-sm)
        }

        .corp-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: .5rem
        }

        .price-info {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: 1rem
        }

        .price-big {
            font-size: 1.5rem;
            font-weight: 700
        }

        .price-label {
            font-size: 1rem;
            color: #6c757d
        }

        .price-change.positive {
            color: #dc3545
        }

        .price-change.negative {
            color: #0d6efd
        }

        .change-badge {
            font-size: .85rem;
            padding: .125rem .5rem;
            border-radius: .5rem;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            gap: .25rem
        }

        .change-badge.up {
            color: #dc3545;
            background: rgba(220, 53, 69, .12)
        }

        .change-badge.down {
            color: #0d6efd;
            background: rgba(13, 110, 253, .12)
        }

        .change-badge.neutral {
            color: #6c757d;
            background: rgba(108, 117, 125, .12)
        }

        .candle-container {
            height: 180px;
            flex: 0 0 auto
        }

        .lower-box {
            flex: 1 1 40%;
            overflow: auto
        }

        #custom_candle_chart {
            width: 100%;
            height: 100%
        }

        table.table td, table.table th {
            vertical-align: middle
        }

        #ratioTable tr:hover {
            background: #f8f9fa;
            cursor: pointer
        }

        .table-responsive thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 2
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1080
        }

        .chart-wrapper {
            height: 300px
        }

        #stockChart {
            width: 100% !important;
            height: 100% !important
        }

        .factor-card {
            background: #f8f9fa;
            border-radius: var(--card-radius)
        }

        .factor-body {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: var(--card-radius);
            padding: 1rem;
            box-shadow: var(--shadow-sm)
        }

        #factorChart {
            width: 100% !important;
            height: 240px !important
        }

        .sub-divider {
            border-top: 1px solid #dee2e6;
            height: 1px;
            margin: .25rem 0 .75rem
        }

        .mini-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm)
        }

        .mini-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .5rem .75rem;
            border-bottom: 1px solid #f1f3f5;
            flex-wrap: wrap;
            gap: .5rem;
        }

        .mini-card-title {
            font-weight: 700;
            font-size: .95rem;
            margin: 0;
            white-space: nowrap;
            word-break: keep-all;
        }

        .mini-card-body {
            padding: .75rem;
            height: auto;
        }

        /* 차트처럼 높이가 필요한 카드에만 선택 적용 */
        .mini-card-body.h-220 {
            height: 220px;
        }

        .mini-card-body.h-260 {
            height: 260px;
        }

        .mini-card-body.h-320 {
            height: 320px;
        }

        .mini-card-body canvas {
            width: 100% !important;
            height: 100% !important
        }

        .outlook-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            margin-top: .75rem;
            overflow: hidden
        }

        .outlook-header {
            display: flex;
            align-items: center;
            gap: .5rem;
            justify-content: space-between;
            padding: .5rem .75rem;
            border-bottom: 1px solid #f1f3f5
        }

        .outlook-title {
            font-weight: 700;
            font-size: .95rem;
            margin: 0
        }

        .outlook-tabs .btn {
            padding: .15rem .5rem;
            font-size: .8rem
        }

        .outlook-body {
            padding: .5rem;
            height: 280px;
            position: relative
        }

        .outlook-body canvas {
            width: 100% !important;
            height: 100% !important
        }

        .risk-kpi {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: .75rem;
            box-shadow: var(--shadow-sm)
        }

        .risk-kpi-label {
            font-size: .85rem;
            color: #6c757d
        }

        .risk-kpi-value {
            font-weight: 800;
            font-size: 1.25rem;
            letter-spacing: .2px
        }

        .strategy-panel {
            position: sticky;
            top: 0.5rem;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
        }

        .strategy-panel .mini-card-header {
            padding: .6rem .75rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .strategy-panel .mini-card-body {
            padding: .75rem; /* 높이 고정 없이 내용에 맞게 */
        }

        .strategy-row {
            display: grid;
            gap: .5rem;
            grid-template-columns: 1fr; /* 모바일: 1열 */
        }

        @media (min-width: 992px) {
            .strategy-row {
                grid-template-columns: 1fr auto auto;
            }

            /* 데스크톱: [뱃지+드롭다운] [리스크] [실행버튼] */
        }

        @media (min-height: 900px) {
            .content-container {
                min-height: 500px;
            }
        }

        .strategy-actions {
            flex-wrap: nowrap;
        }

        /* 그룹 자체 줄바꿈 방지 */
        .strategy-actions .btn {
            white-space: nowrap; /* 공백에서 줄바꿈 금지 */
            word-break: keep-all; /* 한글 단어 단위 유지 (글자 단위 쪼개기 방지) */
            min-width: 108px; /* (옵션) 버튼 폭 통일 — 이미 있으면 생략 가능 */
        }

        .strategy-field {
            min-width: 260px;
        }

        .badge button.btn-close {
            transform: scale(.85);
        }

        #kindsPills .badge {
            font-size: .8rem;
            background: #f1f3f5;
            border: 1px solid #dee2e6;
        }

        #kindsPills .btn-close {
            transform: scale(.8);
        }

        #kindsPills:empty {
            display: none;
        }

        .prompt-row .input-group {
            width: 100%;
            max-width: none;
        }

        /* 헤더 우측 액션 컨테이너 */
        .mini-card-header .header-actions {
            margin-left: auto; /* 타이틀 오른쪽으로 밀기 */
            display: flex;
            align-items: center;
            gap: .5rem;
            flex-wrap: wrap; /* 좁을 때 아래로 내려감 */
        }

        .mini-card-header .header-actions .btn-group,
        .mini-card-header .header-actions .input-group {
            flex-wrap: nowrap; /* 버튼/인풋 내부는 줄바꿈 금지 */
        }

        .logo-square--lg {
            width: 80px;
            height: 80px;
        }

        /* ===== Chat Log (nice bubbles) ===== */
        #log {
            background: #f7f8fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 10px; /* 메시지 간격 */
            height: 400px;
            overflow-y: auto;
        }

        /* 한 줄 전체(아바타 + 말풍선) */
        #log .msg {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 100%;
        }

        /* 역할별 정렬 */
        #log .msg.user {
            justify-content: flex-end;
        }

        #log .msg.assistant {
            justify-content: flex-start;
        }

        /* 아바타 */
        #log .avatar {
            width: 28px;
            height: 28px;
            flex: 0 0 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: #dee2e6;
            color: #495057;
            user-select: none;
        }

        #log .msg.user .avatar {
            background: #0d6efd;
            color: #fff;
        }

        #log .msg.system .avatar {
            background: #adb5bd;
            color: #fff;
        }

        /* 말풍선 */
        #log .bubble {
            max-width: min(72ch, 92%);
            padding: 10px 12px;
            border-radius: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
            white-space: pre-wrap; /* 줄바꿈 유지 */
            word-break: break-word; /* 한국어/긴단어 줄바꿈 */
            position: relative;
            line-height: 1.45;
            font-size: .95rem;
        }

        /* 역할별 색감 */
        #log .msg.user .bubble {
            background: #0d6efd;
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        #log .msg.assistant .bubble {
            background: #ffffff;
            color: #212529;
            border-bottom-left-radius: 6px;
        }

        #log .msg.system .bubble {
            background: #fff3cd;
            color: #7a6400;
            border-bottom-left-radius: 6px;
        }

        /* 타임스탬프/작은 정보 */
        #log .meta {
            display: inline-block;
            font-size: .78rem;
            color: #868e96;
            margin-left: .4rem;
        }

        /* 코드/인라인코드 */
        #log .bubble code {
            background: rgba(33, 37, 41, .06);
            padding: 0 .25em;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        #log .bubble pre {
            margin: .4rem 0 0;
            background: #0b0c0e;
            color: #e9ecef;
            padding: .75rem;
            border-radius: 10px;
            overflow: auto;
            font-size: .85rem;
        }

        /* 긴 답변 접기(토글 앵커) */
        #log .show-more {
            display: inline-block;
            margin-top: .4rem;
            font-size: .85rem;
            color: #0d6efd;
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
<header class="container-fluid d-flex align-items-center gap-3 flex-nowrap">
    <div class="logo-square">
        <img alt="NH 로고" loading="lazy" src="/img/nh_symbol.gif" th:src="@{/img/nh_symbol.gif}">
    </div>
    <h1 class="h4 mb-0 text-truncate" th:text="${#strings.isEmpty(pageTitle) ? '재무 대시보드' : pageTitle}"></h1>
    <!-- 오른쪽 끝 로고 -->
    <div class="logo-square ms-auto logo-square--lg">
        <img alt="NH NSCS" loading="lazy" src="/img/nh_nscs.png" th:src="@{/img/nh_nscs.png}">
    </div>
</header>

<div class="body-header container-fluid d-flex align-items-center flex-wrap">
    <label class="form-label mb-0 fw-bold" for="officeCode">사무소코드</label>
    <input aria-describedby="officeHelp" class="form-control form-control-sm" id="officeCode" inputmode="numeric"
           maxlength="6"
           oninput="if(this.value.length>6)this.value=this.value.slice(0,6);" pattern="[0-9]*" placeholder="6자리 숫자"
           style="max-width:150px"
           type="number">
    <small class="text-muted ms-1" id="officeHelp">숫자 6자리</small>
    <button class="btn btn-sm btn-primary" type="button">확인</button>
</div>

<main class="container-fluid py-2">
    <div class="content-container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-target="#main" data-bs-toggle="tab" role="tab">메인</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-target="#ratio" data-bs-toggle="tab" role="tab">재무비율</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-target="#profit" data-bs-toggle="tab" role="tab">손익/위험</button>
            </li>
        </ul>

        <div class="corp-name" th:text="${brcInfos[0]?.brnm} ?: 'XX농협'"></div>

        <div class="tab-content mt-3">
            <!-- Main -->
            <div class="tab-pane fade show active" id="main" role="tabpanel">
                <div class="row g-3">
                    <aside class="col-lg-3 col-md-4">
                        <div class="d-flex flex-column gap-3 h-100">
                            <section aria-labelledby="priceIntroTitle" class="p-3 border bg-light rounded-2">
                                <div aria-label="현재 가격 정보" class="price-info" id="priceIntroTitle">
                                    <!-- 가격 숫자 -->
                                    <span class="price-big" id="price-now"
                                          th:text="${#numbers.formatInteger((quote?.price) ?: 22500, 0)}">22,500</span>

                                    <!-- 통화 -->
                                    <span class="price-label" id="price-ccy"
                                          th:text="${(quote?.currency) ?: 'KRW'}">KRW</span>
                                    <!-- 등락률 (이전 오류의 원인: 비교식과 ?:) -->
                                    <span class="price-change visually-hidden"
                                          th:classappend="${(quote?.changePercent ?: 0) >= 0} ? ' positive' : ' negative'"
                                          th:text="${(quote?.changePercent) != null ? #numbers.formatDecimal(quote.changePercent, 1, 2) + '%' : '-0.56% ▼ ₩500'}">-0.56% ▼ ₩500</span>
                                    <span aria-label="전일 대비 등락률" class="change-badge" id="price-change-pct">--%</span>
                                    <span aria-label="전일 대비 금액" class="change-badge" id="price-change-abs">--</span>
                                </div>
                                <div class="mt-3">
                                    <h2 class="h6 fw-bold mb-1">소개</h2>
                                    <hr class="mt-0 mb-2">

                                    <!-- 소개 요약 정보 -->
                                    <dl class="row g-2 small mb-2">
                                        <dt class="col-4 col-sm-3 text-muted">조합장</dt>
                                        <dd class="col-8 col-sm-9"
                                            th:text="${brcInfos[0]?.ceoNm} ?: '—'">—
                                        </dd>

                                        <dt class="col-4 col-sm-3 text-muted">설립일</dt>
                                        <dd class="col-8 col-sm-9"
                                            th:text="${brcInfos[0] != null and !#strings.isEmpty(brcInfos[0].foundationDt) ? brcInfos[0].foundationDt : '—'}">
                                            —
                                        </dd>

                                        <dt class="col-4 col-sm-3 text-muted">직원수</dt>
                                        <dd class="col-8 col-sm-9"
                                            th:text="${brcInfos[0]?.employees != null ? #numbers.formatInteger(brcInfos[0].employees,0) + '명' : '—'}">
                                            —
                                        </dd>

                                        <dt class="col-4 col-sm-3 text-muted">주소</dt>
                                        <dd class="col-8 col-sm-9"
                                            th:text="${brcInfos[0]?.address} ?: '—'">—
                                        </dd>
                                    </dl>

                                    <!-- 소개글 위 구분선 -->
                                    <hr class="my-2">

                                    <!-- 소개 본문 -->
                                    <p class="mb-0" style="font-size:0.9rem"
                                       th:text="${brcInfos[0]?.description} ?: '여기에 회사 소개 글을 입력하세요.'"></p>
                                </div>
                            </section>

                            <section aria-labelledby="factorTitle" class="p-3 factor-card border rounded-2 flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <h2 class="h6 fw-bold mb-0" id="factorTitle">팩터 분석</h2>
                                    <button class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1"
                                            data-bs-toggle="tooltip"
                                            title="6대 팩터(변동성·밸류·사이즈·모멘텀·베타·전망치) 상대 점수(0~100)" type="button">
                                        <span style="font-size:.85rem">❔</span></button>
                                </div>
                                <div class="factor-body">
                                    <canvas aria-label="팩터 분석 차트" id="factorChart" role="img"></canvas>
                                </div>
                            </section>
                        </div>
                    </aside>

                    <div class="col-lg-9 col-md-8">
                        <section class="p-3 border bg-white rounded-2 h-100 d-flex flex-column">
                            <div class="candle-container border-bottom p-2">
                                <div aria-label="캔들 차트" id="custom_candle_chart" role="img"></div>
                            </div>

                            <section aria-labelledby="outlookTitle" class="outlook-card">
                                <div class="outlook-header">
                                    <div class="d-flex align-items-center gap-2">
                                        <h3 class="outlook-title mb-0" id="outlookTitle">전문가 전망치</h3>
                                        <span class="text-muted" data-bs-toggle="tooltip"
                                              title="애널리스트 목표가 기준 12개월 전망">❔</span>
                                    </div>
                                    <div class="outlook-tabs btn-group btn-group-sm" role="group">
                                        <button class="btn btn-success active" disabled type="button">12개월 전망</button>
                                        <button class="btn btn-outline-secondary" disabled type="button">전망 분포</button>
                                        <button class="btn btn-outline-secondary" disabled type="button">전망치 추이</button>
                                    </div>
                                </div>
                                <div class="outlook-body">
                                    <canvas id="outlookChart"></canvas>
                                </div>
                            </section>

                            <div class="lower-box p-2">
                                <div aria-label="보조 지표 구분선" class="sub-divider" role="separator"></div>
                                <div class="row g-3">
                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">손익현황</h3>
                                                <div aria-label="값 보기 전환" class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-secondary active" id="mixAbsBtn"
                                                            type="button">절대값
                                                    </button>
                                                    <button class="btn btn-outline-secondary" id="mixPctBtn"
                                                            type="button">비율화
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mini-card-body h-260">
                                                <canvas id="salesMixChart"></canvas>
                                            </div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">배당현황</h3>
                                            </div>
                                            <div class="mini-card-body h-260">
                                                <canvas id="profitRateChart"></canvas>
                                            </div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">이익성장률 (YoY)</h3>
                                            </div>
                                            <div class="mini-card-body h-260">
                                                <canvas id="growthChart"></canvas>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Ratio -->
            <div class="tab-pane fade" id="ratio" role="tabpanel">
                <div class="mb-2 d-flex gap-2 justify-content-end align-items-center flex-wrap">
                    <select class="form-select form-select-sm" id="yearRange" style="max-width:160px">
                        <option selected value="5">최근 5개년</option>
                        <option value="3">최근 3개년</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="btnResetZoom" type="button">줌 리셋</button>
                    <button class="btn btn-sm btn-outline-secondary" id="btnExportPng" type="button">PNG 내보내기</button>
                    <button class="btn btn-sm btn-outline-secondary" id="btnExportCsv" type="button">CSV 내보내기</button>
                    <button class="btn btn-sm btn-danger" onclick="clearAll()" type="button">전체 지표 제거</button>
                </div>
                <div class="chart-wrapper mb-3">
                    <canvas aria-label="재무비율 선택 차트" id="stockChart" role="img"></canvas>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered text-center align-middle" id="ratioTable">
                        <thead class="table-light">
                        <tr>
                            <th style="width:180px">지표 분류</th>
                            <th>지표</th>
                            <th th:each="y : ${years}" th:text="${y + '년'}">2020년</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- ========== 수익성 비율 ========== -->
                        <tr>
                            <td rowspan="7">수익성 비율</td>
                            <td>순이자마진(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.netInterestMarginPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>세전순이익률(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.preTaxProfitMarginPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>순이익률(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.netProfitMarginPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>자기자본이익률(%) - ROE</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.returnOnEquityRoePct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총자산순이익률(%) - ROA</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.returnOnAssetsRoaPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>영업현금흐름전환비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.operatingCfConversionRatioPct) ?: '—'}">
                                —
                            </td>
                        </tr>
                        <tr>
                            <td>자산효율성비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.assetEfficiencyRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 운영효율성 비율 ========== -->
                        <tr>
                            <td rowspan="4">운영효율성 비율</td>
                            <td>효율성비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.efficiencyRatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총자산회전율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.totalAssetTurnoverPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>금융자산회전율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.financialAssetTurnoverPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>영업레버리지비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.operatingLeverageRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 자산건전성 비율 ========== -->
                        <tr>
                            <td rowspan="3">자산건전성 비율</td>
                            <td>보통주자본(CET1)비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.cet1RatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>기본자본(Tier1)비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.tier1RatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총자본비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.totalCapitalRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 기타 재무비율 ========== -->
                        <tr>
                            <td rowspan="3">기타 재무비율</td>
                            <td>Tier1레버리지비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.tier1LeverageRatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>예대율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.loanToDepositRatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>유동성커버리지비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.liquidityCoverageRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 신용 비율 ========== -->
                        <tr>
                            <td rowspan="2">신용 비율</td>
                            <td>총여신대비부실채권 비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.nplRatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총여신대비대손충당금 비율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.loanLossReserveRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 이자율 ========== -->
                        <tr>
                            <td rowspan="2">이자율</td>
                            <td>예수부채이자율(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.depositInterestRatePct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총여신대비이자및수수료(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.interestFeeToLoanRatioPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 기타(스코어) ========== -->
                        <tr>
                            <td rowspan="3">기타</td>
                            <td>피오트로스키 F-스코어</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.piotroskiFScore) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>베네시 M-스코어</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.beneishMScore) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>모한람 G-스코어</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.gScore) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 주주환원 수익률 ========== -->
                        <tr>
                            <td rowspan="2">주주환원 수익률</td>
                            <td>배당수익률(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.dividendYieldPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>총 수익률(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.totalReturnPct) ?: '—'}">—</td>
                        </tr>

                        <!-- ========== 주주환원 성향 ========== -->
                        <tr>
                            <td rowspan="2">주주환원 성향</td>
                            <td>배당성향(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.dividendPayoutRatioPct) ?: '—'}">—</td>
                        </tr>
                        <tr>
                            <td>수정배당성향(%)</td>
                            <td th:each="y : ${years}" th:text="${(fr.get(y)?.adjustedPayoutRatioPct) ?: '—'}">—</td>
                        </tr>

                        </tbody>

                    </table>
                </div>
            </div>

            <!-- Profit -->
            <div class="tab-pane fade p-3" id="profit" role="tabpanel">
                <!-- 경영전략 작업 영역 -->

                <div class="row g-3 align-items-stretch">
                    <div class="col-12 col-lg-6 d-flex flex-column" style="min-height:0">
                        <section class="mini-card">
                            <div class="mini-card-header">
                                <h3 class="mini-card-title mb-0">핵심 지표</h3>
                            </div>
                            <div class="p-3">
                                <div class="row g-3">
                                    <div class="col-6 col-lg-6">
                                        <div aria-label="PER" class="risk-kpi">
                                            <div class="risk-kpi-label">PER</div>
                                            <div class="risk-kpi-value" id="kpiPER"
                                                 th:text="${#numbers.formatDecimal(brcValues[4].per ?: null, 1, 2)} ?: '--배'">
                                                --배
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-6">
                                        <div aria-label="PBR" class="risk-kpi">
                                            <div class="risk-kpi-label">PBR</div>
                                            <div class="risk-kpi-value" id="kpiPBR"
                                                 th:text="${#numbers.formatDecimal(brcValues[4].pbr ?: null, 1, 2)} ?: '--배'">
                                                --배
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-4">
                                        <div aria-label="EV/Sales" class="risk-kpi">
                                            <div class="risk-kpi-label">EV/Sales</div>
                                            <div class="risk-kpi-value" id="kpiEVS"
                                                 th:text="${#numbers.formatDecimal(brcValues[4].evSales ?: null, 1, 2)} ?: '--배'">
                                                --배
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-4">
                                        <div aria-label="EV/EBITDA" class="risk-kpi">
                                            <div class="risk-kpi-label">EV/EBITDA</div>
                                            <div class="risk-kpi-value" id="kpiEVEBITDA"
                                                 th:text="${#numbers.formatDecimal(brcValues[4].evEbitda ?: null, 1, 2)} ?: '--배'">
                                                --배
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-6 col-lg-4">
                                        <div aria-label="EV/EBIT" class="risk-kpi">
                                            <div class="risk-kpi-label">EV/EBIT</div>
                                            <div class="risk-kpi-value" id="kpiEVEBIT"
                                                 th:text="${#numbers.formatDecimal(brcValues[4].evEbit ?: null, 1, 2)} ?: '--배'">
                                                --배
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>


                        <section class="mini-card mt-3 flex-grow-1 d-flex flex-column" style="min-height:0">
                            <div class="mini-card-header">
                                <h3 class="mini-card-title mb-0">연도별 핵심지표흐름</h3>
                            </div>
                            <div class="mini-card-body flex-grow-1" style="overflow:auto; min-height:240px">
                                <canvas aria-label="누적 손익 차트" id="pnlCurveChart" role="img"></canvas>
                            </div>
                        </section>
                    </div>

                    <div class="col-12 col-lg-6 d-flex flex-column" style="min-height:0">
                        <!-- 전략생성옵션모음 시작 -->
                        <section class="mini-card mb-3">
                            <div class="mini-card-header">
                                <h3 class="mini-card-title mb-0">전략 옵션</h3>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="input-group input-group-sm" style="min-width:160px; max-width:200px;">
                                        <span class="input-group-text">리스크</span>
                                        <select class="form-select" id="stratRisk">
                                            <option value="conservative">보수적</option>
                                            <option selected value="moderate">중립</option>
                                            <option value="aggressive">공격적</option>
                                        </select>
                                    </div>
                                    <div aria-label="전략 실행 버튼"
                                         class="btn-group btn-group-sm strategy-actions flex-nowrap"
                                         role="group">
                                        <button class="btn btn-primary" id="btnGenStrategy" type="button">전략 생성</button>
                                        <button class="btn btn-outline-secondary" id="btnRiskAudit" type="button">리스크
                                            점검
                                        </button>
                                        <button class="btn btn-outline-secondary" id="btnRebalance" type="button">리밸런싱
                                            제안
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mini-card-body">

                                <div class="d-flex flex-wrap gap-2 justify-content-between align-items-start mb-2">


                                    <!-- ▼▼▼ 전략 옵션 UI: 프롬프트 인풋 아래에 추가 ▼▼▼ -->

                                    <div class="dropdown" data-bs-auto-close="outside">
                                        <button aria-expanded="false"
                                                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                                data-bs-toggle="dropdown" id="stratKindsBtn" type="button">
                                            전략유형 선택
                                        </button>

                                        <div class="dropdown-menu p-2"
                                             id="stratKindsMenu"
                                             style="min-width:240px; max-height:240px; overflow:auto">
                                            <!-- 카테고리로 그룹핑(선택) -->
                                            <div class="text-muted small px-2 pb-1">자산 배분</div>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="barbell"> 바벨
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="balanced"> 균형형
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="riskParity"> 리스크 패리티
                                            </label>
                                            <div class="text-muted small px-2 pt-2 pb-1 border-top">스타일/팩터</div>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="aggressive"> 공격적
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="defensive"> 방어적
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="value"> 가치
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="growth"> 성장
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="dividend"> 배당
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="momentum"> 모멘텀
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="quality"> 퀄리티
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]"
                                                       type="checkbox" value="dualMomentum"> 듀얼 모멘텀
                                            </label>
                                            <label class="dropdown-item d-flex align-items-center gap-2">
                                                <input class="form-check-input me-1" name="stratKinds[]" type="checkbox"
                                                       value="hedged"> 헤지
                                            </label>

                                            <div class="d-flex gap-2 mt-2 px-2">
                                                <button class="btn btn-sm btn-light" id="kindsClear" type="button">초기화
                                                </button>
                                                <button class="btn btn-sm btn-primary ms-auto" data-bs-toggle="dropdown"
                                                        type="button">확인
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ms-2 d-flex flex-wrap gap-1" id="kindsPills"></div>

                                </div>

                                <div class="border-top my-2 w-100"></div>
                                <div class="mt-2 small text-primary text-center" id="actionGuide"></div>
                                <!-- ▲▲▲ 전략 옵션 UI: 여기까지 ▲▲▲ -->

                            </div>

                        </section>
                        <!-- 전략생성옵션모음 끝 -->
                        <section class="mini-card flex-grow-1 d-flex flex-column" style="min-height:0">
                            <div class="mini-card-header">
                                <h3 class="mini-card-title mb-0">생성형 AI 분석</h3>
                            </div>
                            <div class="mini-card-body flex-grow-1" style="overflow:auto; min-height:240px">
                                <div class="input-row mb-2 d-flex gap-2 align-items-start">
                                    <!-- textarea 내부 텍스트는 비워둡니다 (공백/개행 X) -->
                                    <textarea class="form-control flex-grow-1" id="prompt"
                                              placeholder="예) 현재 사무소 재무비율 분석해줘"
                                              rows="1"></textarea>

                                    <button class="btn btn-primary flex-shrink-0" id="sendBtn"
                                            style="width: 120px;">보내기
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between small text-muted mb-2">
                                    <span>Enter=전송 / Shift+Enter=줄바꿈</span>
                                </div>
                                <div class="log border rounded p-2" id="log"
                                     style="overflow-y:auto; background:#fcfcfd"></div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>© <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span> D.N.A 1조</footer>
<div aria-atomic="true" aria-live="polite" class="toast-container"></div>

<!-- Inline App Script -->
<script th:inline="javascript">

    let skipStrategyOptions = false;
    // 공통 유틸: 어떤 값이 와도 배열로 보정
    const asArray = (x) => Array.isArray(x) ? x : (x ? [x] : []);
    /* ===== Bootstrap Tooltip ===== */
    (function () {
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
            .forEach(el => new bootstrap.Tooltip(el));
    })();

    /* ===== Zoom plugin: register once (robust) ===== */
    (function () {
        if (!window.Chart) return;
        const zoom = window['chartjs-plugin-zoom'] || window.ChartZoom;
        try {
            if (zoom) Chart.register(zoom);
        } catch (_) {
        }
    })();

    /* ===== Data from server (with fallbacks) ===== */
    const YEARS = /*[[${years}]]*/ null || ["2020", "2021", "2022", "2023", "2024"];
    // 1) 팩터
    const _RAW_FACTOR = asArray( /*[[${factorScores}]]*/ null);

    function normalizeFactor(raw) {
        if (raw.length === 0) return [0, 0, 0, 0, 0, 0];
        if (typeof raw[0] === 'number') {
            return (raw.length >= 6) ? raw.slice(0, 6) : [...raw, ...Array(6 - raw.length).fill(0)];
        }
        const o = raw[0] || {};
        return [
            +o.volatility || 0,
            +o.valueFactor || 0,
            +o.sizeFactor || 0,
            +o.momentum || 0,
            +o.beta || 0,
            +o.outlook || 0
        ];
    }

    const FACTOR_DATA = normalizeFactor(_RAW_FACTOR);

    // 2) 주가
    const STOCKS = /*[[${stockPrices}]]*/ null || [];
    const CANDLES = STOCKS.map(d => {
        const s = String(d?.basDt ?? '');
        const time = (s.length === 8) ? `${s.slice(0, 4)}-${s.slice(4, 6)}-${s.slice(6, 8)}` : (d?.basDt ?? '');
        return {
            time,
            open: +d?.open || 0,
            high: +d?.high || 0,
            low: +d?.low || 0,
            close: +d?.close || 0
        };
    });

    // 3) 보조 데이터들도 동일하게
    const INCOMES = /*[[${incomePrices}]]*/ null || [];
    const PROFITS = /*[[${profitMargins}]]*/ null || [];
    const PROGROWTH = /*[[${profitGrowths}]]*/ null || [];


    /* ===== Radar Chart for factor ===== */
    (function () {
        const canvas = document.getElementById('factorChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['변동성', '밸류', '사이즈', '모멘텀', '베타', '전망치'],
                datasets: [{
                    label: '팩터 점수',
                    data: FACTOR_DATA,
                    backgroundColor: 'rgba(54,162,235,0.2)',
                    borderColor: 'rgba(54,162,235,1)',
                    pointBackgroundColor: 'rgba(54,162,235,1)',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.25
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {legend: {display: false}},
                scales: {
                    r: {
                        beginAtZero: true,
                        min: 0,
                        max: 100,
                        ticks: {stepSize: 20},
                        angleLines: {color: '#eee'},
                        grid: {color: '#ddd'}
                    }
                }
            }
        });
    })();

    /* ===== Candlestick (Lightweight) + Outlook (Chart.js) ===== */
    (function () {
        const el = document.getElementById('custom_candle_chart');
        if (!window.LightweightCharts || !el) {
            return;
        }

        const chart = LightweightCharts.createChart(el, {
            width: el.clientWidth, height: el.clientHeight,
            layout: {background: {type: 'solid', color: '#fff'}, textColor: '#333'},
            grid: {vertLines: {color: '#eee'}, horzLines: {color: '#eee'}},
            rightPriceScale: {visible: true},
            timeScale: {borderColor: '#eee', timeVisible: true}
        });

        const series = chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350',
            wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        const hasCandles = Array.isArray(CANDLES) && CANDLES.length > 0;
        series.setData(hasCandles ? CANDLES : []);
        if (hasCandles) chart.timeScale().fitContent();

        if (window.ResizeObserver) {
            const ro = new ResizeObserver(entries => {
                const {width, height} = entries[0].contentRect;
                chart.resize(Math.max(50, Math.floor(width)), Math.max(100, Math.floor(height)));
            });
            ro.observe(el);
        }
        window.addEventListener('resize', () => chart.resize(el.clientWidth, el.clientHeight));
        requestAnimationFrame(() => chart.resize(el.clientWidth, el.clientHeight));

        const mainTabBtn = document.querySelector('[data-bs-target="#main"]');
        mainTabBtn?.addEventListener('shown.bs.tab', () => {
            chart.resize(el.clientWidth, el.clientHeight);
            chart.timeScale().fitContent();
            requestAnimationFrame(() => window._outlookChart?.resize?.());
        });

        // ===== Outlook =====
        const canvas = document.getElementById('outlookChart');
        if (!canvas || !window.Chart) return;
        const outlookCtx = canvas.getContext('2d');
        if (!outlookCtx) return;
        const nf = new Intl.NumberFormat('ko-KR');

        const lastClose = hasCandles
            ? CANDLES[CANDLES.length - 1].close
            : ((/*[[${quote?.price}]]*/ 22500) || 22500);

        const OUTLOOK = /*[[${stockOutlooks}]]*/ null || [];

        const highs = OUTLOOK.map(o => +o?.high).filter(Number.isFinite);
        const lows = OUTLOOK.map(o => +o?.low).filter(Number.isFinite);
        const mids = OUTLOOK.map(o => +o?.close).filter(Number.isFinite);

        const target = {
            max: highs.length ? Math.max(...highs) : lastClose,
            min: lows.length ? Math.min(...lows) : lastClose,
            avg: mids.length ? Math.round(mids.reduce((a, b) => a + b, 0) / mids.length) : lastClose
        };
        const history = hasCandles ? CANDLES.map(d => d.close) : [lastClose];

        // ▶▶ 여기 추가: 미래 더미 칸
        const FUTURE_STEPS = 32;

        // 라벨: 과거 날짜들 + 빈칸(FUTURE_STEPS) + "12개월 후"
        const labels = (hasCandles ? CANDLES.map(d => d.time) : ['현재'])
            .concat(Array(FUTURE_STEPS).fill(''))
            .concat(['12개월 후']);
        const nowIndex = history.length - 1;
        const endIndex = labels.length - 1;
        const histData = history.concat(Array(FUTURE_STEPS + 1).fill(null));
        const projAt = (targetVal) => {
            const arr = new Array(labels.length).fill(null);
            arr[nowIndex] = lastClose;   // 현재
            arr[endIndex] = targetVal;   // 12개월 후
            return arr;
        };
        const projMax = projAt(target.max);
        const projAvg = projAt(target.avg);
        const projMin = projAt(target.min);

        const allVals = history.concat([target.min, target.max]);
        const yMin = Math.min(...allVals);
        const yMax = Math.max(...allVals);
        const pad = Math.max(100, (yMax - yMin) * 0.1);

        const outlookLabel = {
            id: 'outlookLabel',
            afterDatasetsDraw(chart) {
                const {ctx, scales, chartArea} = chart;
                const x = scales?.x, y = scales?.y;
                if (!x || !y || !chartArea) return;
                const {top, bottom} = chartArea;
                const endIndex = labels.length - 1;
                ctx.save();

                function roundRect(ctx, x, y, w, h, r) {
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.arcTo(x + w, y, x + w, y + h, r);
                    ctx.arcTo(x + w, y + h, x, y + h, r);
                    ctx.arcTo(x, y + h, x, y, r);
                    ctx.arcTo(x, y, x + w, y, r);
                    ctx.closePath();
                }

                function drawTag(yVal, text, color) {
                    const xEnd = x.getPixelForValue(endIndex);
                    const yEnd = y.getPixelForValue(yVal);
                    const padX = 8;
                    ctx.font = '12px system-ui,-apple-system,Segoe UI,Roboto';
                    const metrics = ctx.measureText(text);
                    const boxW = metrics.width + padX * 2, boxH = 22;
                    const rx = 6;
                    const bx = Math.min(chart.width - boxW - 4, xEnd + 6);
                    const by = Math.min(Math.max(yEnd - boxH / 2, top + 2), bottom - boxH - 2);
                    ctx.fillStyle = '#fff';
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1.2;
                    roundRect(ctx, bx, by, boxW, boxH, rx);
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = color;
                    ctx.fillText(text, bx + padX, by + boxH / 1.5);
                }

                const fmt = (v) => {
                    const diff = v - lastClose;
                    const sign = diff > 0 ? '+' : '-';
                    return `${diff === 0 ? '±' : sign}${Math.abs(diff / lastClose * 100).toFixed(2)}%  ₩${nf.format(v)}`;
                };
                drawTag(target.max, `최고 ${fmt(target.max)}`, '#198754');
                drawTag(target.avg, `평균 ${fmt(target.avg)}`, '#198754');
                drawTag(target.min, `최저 ${fmt(target.min)}`, '#dc3545');

                const xNow = x.getPixelForValue(nowIndex);
                const yNow = y.getPixelForValue(lastClose);
                ctx.fillStyle = '#212529';
                ctx.beginPath();
                ctx.arc(xNow, yNow, 4, 0, Math.PI * 2);
                ctx.fill();
                const nowText = `현재가 ₩${nf.format(lastClose)}`;
                const m = ctx.measureText(nowText);
                const w = m.width + 16, h = 20;
                const rx = 6;
                const nx = Math.max(Math.min(xNow - w - 8, chart.width - w - 4), 8);
                const ny = Math.min(Math.max(yNow - h / 2, top + 2), bottom - h - 2);
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#6c757d';
                ctx.lineWidth = 1;
                roundRect(ctx, nx, ny, w, h, rx);
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = '#6c757d';
                ctx.fillText(nowText, nx + 8, ny + h / 1.5);
                ctx.restore();
            }
        };

        const grad = outlookCtx.createLinearGradient(0, 0, 0, 280);
        grad.addColorStop(0, 'rgba(43,47,54,0.15)');
        grad.addColorStop(1, 'rgba(43,47,54,0.00)');

        window._outlookChart = new Chart(outlookCtx, {
            plugins: [outlookLabel],
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: '과거', data: histData,
                        borderWidth: 1.5, pointRadius: 0, tension: .25,
                        borderColor: '#2b2f36', fill: true, backgroundColor: grad
                    },
                    {
                        label: '최고', data: projMax, borderColor: '#198754',
                        borderDash: [6, 6],
                        pointRadius: (c) => (c.dataIndex === nowIndex || c.dataIndex === endIndex ? 3 : 0),
                        pointBackgroundColor: '#198754', tension: .15, spanGaps: true
                    },
                    {
                        label: '평균', data: projAvg, borderColor: '#20c997',
                        borderDash: [6, 6],
                        pointRadius: (c) => (c.dataIndex === nowIndex || c.dataIndex === endIndex ? 3 : 0),
                        pointBackgroundColor: '#20c997', tension: .15, spanGaps: true
                    },
                    {
                        label: '최저', data: projMin, borderColor: '#dc3545',
                        borderDash: [6, 6],
                        pointRadius: (c) => (c.dataIndex === nowIndex || c.dataIndex === endIndex ? 3 : 0),
                        pointBackgroundColor: '#dc3545', tension: .15, spanGaps: true
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: {intersect: false, mode: 'nearest'},
                plugins: {
                    legend: {display: false},
                    tooltip: {enabled: true, callbacks: {label: (c) => '₩' + nf.format(c.parsed.y)}},
                    zoom: {
                        pan: {enabled: true, mode: 'x'},
                        zoom: {wheel: {enabled: true}, pinch: {enabled: true}, mode: 'x'}
                    }
                },
                layout: {padding: {right: 160}},
                scales: {
                    x: {
                        type: 'category',
                        offset: true,
                        grid: {display: false},
                        ticks: {maxRotation: 0, autoSkip: true, callback: (value, idx) => labels[idx] || ''}
                    },
                    y: {min: yMin - pad, max: yMax + pad, ticks: {callback: v => '₩' + nf.format(v)}}
                }
            }
        });
    })();

    /* ===== Price header dynamic badges ===== */
    (function () {
        const nowEl = document.getElementById('price-now');
        const pctEl = document.getElementById('price-change-pct');
        const absEl = document.getElementById('price-change-abs');
        if (!nowEl || !pctEl || !absEl) return;
        const nf = new Intl.NumberFormat('ko-KR');

        if (!Array.isArray(CANDLES) || CANDLES.length < 2) {
            const fallback = (/*[[${quote?.price}]]*/ 22500) || 22500;
            nowEl.textContent = nf.format(fallback);
            pctEl.textContent = '— 0.00%';
            absEl.textContent = '— ₩0';
            pctEl.classList.add('neutral');
            absEl.classList.add('neutral');
            return;
        }
        const last = CANDLES[CANDLES.length - 1].close;
        const prev = CANDLES[CANDLES.length - 2].close;
        const diff = last - prev;
        const pct = prev ? (diff / prev * 100) : 0;
        const sign = diff > 0 ? '▲' : diff < 0 ? '▼' : '—';
        const dir = diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral';
        nowEl.textContent = nf.format(last);
        pctEl.textContent = `${sign} ${Math.abs(pct).toFixed(2)}%`;
        absEl.textContent = `${sign} ₩${nf.format(Math.abs(diff))}`;
        [pctEl, absEl].forEach(el => {
            el.classList.remove('up', 'down', 'neutral');
            el.classList.add(dir);
        });
    })();

    /* ===== Support Charts (Sales Mix / Profit Rate / Growth) ===== */
    // 손익현황
    (function () {
        const nf = new Intl.NumberFormat('ko-KR');
        const years = ['2022', '2023', '2024']; //To-Do

        const INCOMES = /*[[${incomePrices}]]*/ [];
        console.log("INCOMES", INCOMES);  // 배열이면 OK

        function toPctStacks(stacks) {
            const totals = years.map((_, i) => stacks.reduce((s, st) => s + (st.data[i] || 0), 0));
            return stacks.map(st => ({
                label: st.label,
                data: st.data.map((v, i) => totals[i] ? +(v / totals[i] * 100).toFixed(2) : 0)
            }));
        }

        const mixDataAbs = {
            labels: years,
            stacks: [      // 데이터 임시적용, 항목정해야하고 금액크기 변환필요
                {label: '이자수익(백만원)', data: INCOMES.map(i => i?.interestIncome1 ?? 0)},
                {label: '수수료수익(백만원)', data: INCOMES.map(i => i?.feeIncome1 ?? 0)},
                {label: '기타신용영업수익(백만원)', data: INCOMES.map(i => i?.otherOperatingIncome1 ?? 0)},
                {label: '경제사업영업수익(백만원)', data: INCOMES.map(i => i?.economicOperatingIncome1 ?? 0)},
                {label: '교육지원사업수익(백만원)', data: INCOMES.map(i => i?.educationSupportIncome1 ?? 0)},
                {label: '영업외수익(백만원)', data: INCOMES.map(i => i?.nonOperatingIncome1 ?? 0)},
            ],
            line: {label: '매출액 대비 당기순이익률', data: INCOMES.map(i => i?.netProfitMargin1 ?? 0)}
        };
        const mixDataPct = {labels: years, stacks: toPctStacks(mixDataAbs.stacks), line: mixDataAbs.line};

        const stackedBarOpts = (isPct = false) => ({
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: {stacked: true},
                y: {
                    stacked: true, position: 'left', beginAtZero: true,
                    ticks: {callback: v => isPct ? v + '%' : '₩' + nf.format(v)}
                },
                y2: {
                    position: 'right', beginAtZero: true, min: 0, max: (isPct ? 100 : 10),
                    grid: {drawOnChartArea: false}, ticks: {callback: v => v + '%'}
                }
            },
            plugins: {legend: {position: 'bottom'}}
        });

        const mixCtx = document.getElementById('salesMixChart')?.getContext('2d');
        if (!mixCtx) return;
        let mixMode = 'abs';
        const mixChart = new Chart(mixCtx, {
            type: 'bar',
            data: {
                labels: mixDataAbs.labels, datasets: [
                    ...mixDataAbs.stacks.map(st => ({
                        type: 'bar',
                        label: st.label,
                        data: st.data,
                        stack: 'stack',
                        order: 2
                    })),
                    {
                        type: 'line',
                        label: mixDataAbs.line.label,
                        data: mixDataAbs.line.data,
                        yAxisID: 'y2',
                        order: 1,
                        tension: .3,
                        pointRadius: 2
                    }
                ]
            },
            options: stackedBarOpts(false)
        });

        function switchMix(mode) {
            if (mixMode === mode) return;
            mixMode = mode;
            const isPct = mode === 'pct';
            const use = isPct ? mixDataPct : mixDataAbs;
            mixChart.data.labels = use.labels;
            for (let i = 0; i < use.stacks.length; i++) {
                mixChart.data.datasets[i].data = use.stacks[i].data;
                mixChart.data.datasets[i].type = 'bar';
                mixChart.data.datasets[i].yAxisID = 'y';
                mixChart.data.datasets[i].stack = 'stack';
            }
            mixChart.data.datasets[use.stacks.length] = {
                ...mixChart.data.datasets[use.stacks.length],
                type: 'line', data: use.line.data, yAxisID: 'y2', order: 1
            };
            mixChart.options = stackedBarOpts(isPct);
            mixChart.update();
            document.getElementById('mixAbsBtn').classList.toggle('active', !isPct);
            document.getElementById('mixPctBtn').classList.toggle('active', isPct);
        }

        document.getElementById('mixAbsBtn')?.addEventListener('click', () => switchMix('abs'));
        document.getElementById('mixPctBtn')?.addEventListener('click', () => switchMix('pct'));

        // 두번째 차트
        const PROFITS = /*[[${profitMargins}]]*/ [];
        console.log("PROFITS", PROFITS);  // 배열이면 OK

        const prCtx = document.getElementById('profitRateChart')?.getContext('2d');
        if (!prCtx) return;
        new Chart(prCtx, {
            type: 'bar',
            data: {
                labels: years, datasets: [
                    {type: 'bar', label: '보통출자배당액(백만원)', data: PROFITS.map(i => i?.commonDividend ?? 0), order: 2},
                    {
                        type: 'line',
                        label: '보통출자배당률',
                        data: PROFITS.map(i => i?.commonDividendRatio2 ?? 0),
                        yAxisID: 'y2',
                        order: 1,
                        tension: .3,
                        pointRadius: 2
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: {beginAtZero: true, ticks: {callback: v => '₩' + new Intl.NumberFormat('ko-KR').format(v)}},
                    y2: {
                        position: 'right',
                        beginAtZero: true,
                        min: 0,
                        max: 10,
                        grid: {drawOnChartArea: false},
                        ticks: {callback: v => v + '%'}
                    }
                },
                plugins: {legend: {position: 'bottom'}}
            }
        });
        // 세번째 차트
        const PROGROWTH = /*[[${profitGrowths}]]*/ [];
        console.log("PROGROWTH", PROGROWTH);  // 배열이면 OK

        const grCtx = document.getElementById('growthChart')?.getContext('2d');
        if (!grCtx) return;
        new Chart(grCtx, {
            type: 'line',
            data: {
                labels: years, datasets: [
                    {
                        label: '당기순이익성장률',
                        data: PROGROWTH.map(i => i?.netIncomeGrowthRatio3 ?? 0),
                        tension: .3,
                        pointRadius: 2
                    },
                    {
                        label: '영업수익성장률',
                        data: PROGROWTH.map(i => i?.operatingRevenueGrowthRatio3 ?? 0),
                        tension: .3,
                        pointRadius: 2
                    },
                    {
                        label: '영업외수익성장률',
                        data: PROGROWTH.map(i => i?.nonOperatingIncomeGrowthRatio3 ?? 0),
                        tension: .3,
                        pointRadius: 2
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {y: {beginAtZero: true, ticks: {callback: v => v + '%'}}},
                plugins: {legend: {position: 'bottom'}}
            }
        });
    })();
    /* ===== Ratio tab chart (create on demand) ===== */
    (function () {
        if (!window.Chart) return;

        const ratioTabBtn = document.querySelector('[data-bs-target="#ratio"]');
        const canvas = document.getElementById('stockChart');
        const table = document.getElementById('ratioTable');
        if (!ratioTabBtn || !canvas || !table) return;

        let ratioChart = null;

        function ensureChart() {
            if (ratioChart) return ratioChart;
            const ctx = canvas.getContext('2d');
            ratioChart = new Chart(ctx, {
                type: 'line',
                data: {labels: YEARS, datasets: []},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    normalized: true,
                    animation: {duration: 200},
                    interaction: {intersect: false, mode: 'nearest'},
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {usePointStyle: true, boxWidth: 10},
                            onClick: (e, item, legend) => {
                                const c = legend.chart;
                                const ds = c.data.datasets[item.datasetIndex];
                                const hidden = !c.isDatasetVisible(item.datasetIndex);
                                c.setDatasetVisibility(item.datasetIndex, hidden);
                                c.update();
                                // 테이블 행 하이라이트 동기화
                                const rows = document.querySelectorAll('#ratioTable tbody tr');
                                rows.forEach(r => {
                                    const parsed = parseRow(r);
                                    if (parsed.label === ds.label) {
                                        if (c.isDatasetVisible(item.datasetIndex)) r.classList.add('table-active');
                                        else r.classList.remove('table-active');
                                    }
                                });
                            }
                        },
                        zoom: {
                            pan: {enabled: true, mode: 'x'},
                            zoom: {wheel: {enabled: true}, pinch: {enabled: true}, mode: 'x'}
                        }
                    },
                    scales: {
                        x: {grid: {display: false}},
                        y: {beginAtZero: false}
                    }
                }
            });
            return ratioChart;
        }

// === [추가] 색상 유틸: 라벨로부터 안정적인 HSL 색 생성 ===
        const _colorCache = new Map();

        function colorFor(label) {
            if (_colorCache.has(label)) return _colorCache.get(label);
            let h = 0;
            for (const ch of label) h = (h * 31 + ch.charCodeAt(0)) % 360;
            const line = `hsl(${h} 70% 45%)`;
            const fill = `hsl(${h} 70% 45% / .15)`;
            const colors = {line, fill};
            _colorCache.set(label, colors);
            return colors;
        }

        function findCategory(tr) {
            // 위로 올라가며 카테고리 셀(첫 셀이 있는 행)을 찾는다
            let r = tr;
            while (r) {
                // 카테고리 셀을 포함하는 행은 셀 개수가 YEARS.length + 2
                if (r.cells.length === YEARS.length + 2) {
                    return (r.cells[0]?.innerText || '').trim();
                }
                r = r.previousElementSibling;
            }
            return '';
        }

        // 테이블 행 클릭 → 시리즈 토글
        function parseRow(tr) {
            const hasCategoryCell = (tr.cells.length === YEARS.length + 2);
            const labelIdx = hasCategoryCell ? 1 : 0;
            const firstYearIdx = labelIdx + 1;

            const cat = findCategory(tr);
            const name = (tr.cells[labelIdx]?.innerText || '').replace(/\s+/g, ' ').trim() || '지표';
            const label = cat ? `${cat} · ${name}` : name;

            const values = YEARS.map((_, i) => {
                const cell = tr.cells[firstYearIdx + i];
                if (!cell) return null;
                const txt = cell.textContent.replace(/[,%\s₩,]/g, '');
                const v = parseFloat(txt);
                return Number.isFinite(v) ? v : null;
            });
            return {label, data: values, tr};
        }

        // === [수정] 데이터셋 추가 시 고유 색 적용 & 보기 개선 ===
        table.addEventListener('click', (e) => {
            const tr = e.target.closest('tr');
            if (!tr || tr.parentElement.tagName !== 'TBODY') return;

            const c = ensureChart();
            const series = parseRow(tr);
            const idx = c.data.datasets.findIndex(d => d.label === series.label);

            if (idx >= 0) {
                c.data.datasets.splice(idx, 1);
                tr.classList.remove('table-active');
            } else {
                const colors = colorFor(series.label);

                c.data.datasets.push({
                    label: series.label,
                    data: series.data,
                    tension: 0.25,
                    pointRadius: 2,
                    borderWidth: 2,
                    borderColor: colors.line,
                    pointBackgroundColor: colors.line,
                    backgroundColor: colors.fill, // replace() 필요 없음
                    fill: false,
                    spanGaps: true
                });
                tr.classList.add('table-active');
            }
            c.update();
        });

        // 탭이 보여질 때 최초 생성/리사이즈
        ratioTabBtn.addEventListener('shown.bs.tab', () => {
            const c = ensureChart();
            c.resize(canvas.clientWidth, canvas.clientHeight);
        });

        // 버튼들 동작
        document.getElementById('btnResetZoom')?.addEventListener('click', () => {
            const c = ensureChart();
            c?.resetZoom?.();
        });
        document.getElementById('btnExportPng')?.addEventListener('click', () => {
            if (!ratioChart) return;
            const a = document.createElement('a');
            a.href = ratioChart.toBase64Image();
            a.download = 'financial-ratios.png';
            a.click();
        });
        document.getElementById('btnExportCsv')?.addEventListener('click', () => {
            const c = ensureChart();
            if (!c || c.data.datasets.length === 0) return;

            const rows = [];
            rows.push(['지표', ...c.data.labels]);                    // 현재 보이는 라벨로
            c.data.datasets.forEach(ds => rows.push([ds.label, ...ds.data]));

            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'financial-ratios.csv';
            a.click();
            URL.revokeObjectURL(a.href);
        });
        window.clearAll = () => {
            const c = ensureChart();
            if (!c) return;
            c.data.datasets = [];
            c.update();
            document.querySelectorAll('#ratioTable tbody tr.table-active')
                .forEach(tr => tr.classList.remove('table-active'));
        };
        const yearSel = document.getElementById('yearRange');
        yearSel?.addEventListener('change', () => {
            const c = ensureChart();
            if (!c) return;
            const n = yearSel.value === '3' ? 3 : 5;
            const start = Math.max(YEARS.length - n, 0);
            c.data.labels = YEARS.slice(start);
            c.data.datasets.forEach(ds => {
                ds.data = ds.data.slice(start);
            });
            c.update();
        });
    })();


    /* ===== Profit/Risk Tab ===== */
    (function () {
        const RETURNS = /*[[${monthlyReturns}]]*/ null || []; //현진선배님TODO
        const PNL_AMOUNT = /*[[${pnlAmount}]]*/ null || []; //현진선배님TODO
        const DECOMP = /*[[${pnlDecomposition}]]*/ null || {labels: [], stacks: [], net: {label: '세전당기손익', data: []}}; //현진선배님TODO

        const nf = new Intl.NumberFormat('ko-KR');

        function stdev(arr) {
            if (!arr.length) return 0;
            const m = arr.reduce((a, b) => a + b, 0) / arr.length;
            const v = arr.reduce((s, x) => s + Math.pow(x - m, 2), 0) / (arr.length - 1 || 1);
            return Math.sqrt(v);
        }

        function annualizeVol(monthlyStd) {
            return monthlyStd * Math.sqrt(12);
        }

        function maxDrawdown(series) { // series: 누적지표(정규화) 시퀀스
            let peak = Number.NEGATIVE_INFINITY, mdd = 0;
            for (const x of series) {
                peak = Math.max(peak, x);
                if (peak <= 0) continue;               // 0 가드
                mdd = Math.min(mdd, (x - peak) / peak);
            }
            return mdd; // 음수
        }

        function toPctStacks(stacks) {
            const arr = Array.isArray(stacks) ? stacks : [];
            // 각 stack.data가 없을 수도 있으니 방어
            const n = arr.reduce((m, s) => Math.max(m, Array.isArray(s?.data) ? s.data.length : 0), 0);
            if (n === 0) return arr.map(s => ({label: s.label, data: []}));

            const totals = Array.from({length: n}, (_, i) =>
                arr.reduce((sum, st) => {
                    const v = Array.isArray(st?.data) ? (st.data[i] ?? 0) : 0;
                    return sum + (Number.isFinite(v) ? v : 0);
                }, 0)
            );

            return arr.map(st => {
                const data = Array.isArray(st?.data) ? st.data : [];
                return {
                    label: st.label,
                    data: Array.from({length: n}, (_, i) => {
                        const v = Number.isFinite(data[i]) ? data[i] : 0;
                        const t = totals[i] || 0;
                        return t ? +((v / t) * 100).toFixed(2) : 0;
                    })
                };
            });
        }

        let pnlCurveChart = null;
        let pnlMode = 'cum';
        let pnlRange = '12';
        let decompMode = 'abs';

        const $profitTabBtn = document.querySelector('[data-bs-target="#profit"]');

        function buildOrUpdateAll() {

            const pnlCtx = document.getElementById('pnlCurveChart').getContext('2d');

            if (!pnlCtx) return;

            if (pnlCurveChart) {
                pnlCurveChart.destroy();
                pnlCurveChart = null;
            }

            // === 데이터 정의 ===
            const BRCVALUES = /*[[${brcValues}]]*/ [];

            const labels = [2020, 2021, 2022, 2023, 2024];

            // === PER, PBR 차트 생성 ===
            pnlCurveChart = new Chart(pnlCtx, {
                data: {
                    labels,
                    datasets: [
                        // PER - 선
                        {
                            type: 'line',
                            label: 'PER',
                            data: BRCVALUES.map(i => i.per),
                            yAxisID: 'yLeft',
                            borderColor: '#1f77b4',      // 진한 청록
                            backgroundColor: '#1f77b4',
                            tension: 0.25,
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false
                        },
                        // PBR - 선
                        {
                            type: 'line',
                            label: 'PBR',
                            data: BRCVALUES.map(i => i.pbr),
                            yAxisID: 'yRight',
                            borderColor: '#ff7f0e',      // 밝은 주황
                            backgroundColor: '#ff7f0e',
                            tension: 0.25,
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false
                        },
                        // EV/Sales - 막대
                        {
                            type: 'bar',
                            label: 'EV/Sales',
                            data: BRCVALUES.map(i => i.evSales),
                            yAxisID: 'yLeft',
                            backgroundColor: '#aec7e8',  // 파스텔 청색
                        },
                        // EV/EBITDA - 막대
                        {
                            type: 'bar',
                            label: 'EV/EBITDA',
                            data: BRCVALUES.map(i => i.evEbitda),
                            yAxisID: 'yLeft',
                            backgroundColor: '#98df8a',  // 파스텔 녹색
                        },
                        // EV/EBIT - 막대
                        {
                            type: 'bar',
                            label: 'EV/EBIT',
                            data: BRCVALUES.map(i => i.evEbit),
                            yAxisID: 'yLeft',
                            backgroundColor: '#ffbb78',  // 파스텔 오렌지
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {intersect: false, mode: 'index'},
                    plugins: {
                        legend: {position: 'bottom'}
                    },
                    scales: {
                        yLeft: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {display: true, text: 'PER / EV Ratios'},
                        },
                        yRight: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            title: {display: true, text: 'PBR'},
                            grid: {drawOnChartArea: false}
                        }
                    }
                }
            });
        }

        // 이벤트 바인딩
        document.getElementById('pnlRange')?.addEventListener('change', (e) => {
            pnlRange = e.target.value;
            buildOrUpdateAll();
        });
        document.getElementById('pnlModeCum')?.addEventListener('click', () => {
            pnlMode = 'cum';
            document.getElementById('pnlModeCum').classList.add('active');
            document.getElementById('pnlModePer').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('pnlModePer')?.addEventListener('click', () => {
            pnlMode = 'per';
            document.getElementById('pnlModePer').classList.add('active');
            document.getElementById('pnlModeCum').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('decompAbs')?.addEventListener('click', () => {
            decompMode = 'abs';
            document.getElementById('decompAbs').classList.add('active');
            document.getElementById('decompPct').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('decompPct')?.addEventListener('click', () => {
            decompMode = 'pct';
            document.getElementById('decompPct').classList.add('active');
            document.getElementById('decompAbs').classList.remove('active');
            buildOrUpdateAll();
        });

        document.getElementById('pnlExportPng')?.addEventListener('click', () => {
            if (!pnlCurveChart) return;
            const url = pnlCurveChart.toBase64Image('image/png', 1);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pnl_curve.png';
            a.click();
        });
        document.getElementById('pnlResetZoom')?.addEventListener('click', () => {
            pnlCurveChart?.resetZoom?.();
        });

        // 탭 표시 시 초기화/리사이즈
        let initialized = false;
        $profitTabBtn?.addEventListener('shown.bs.tab', () => {
            if (!initialized) {
                initialized = true;
                buildOrUpdateAll();
            } else {
                pnlCurveChart?.resize?.();
            }
        });
    })();

    /* ===== Strategy buttons & GenAI output (single source of truth) ===== */
    (function () {
        const $prompt = document.getElementById('prompt');
        const $pnlRange = document.getElementById('pnlRange');
        const $modePer = document.getElementById('pnlModePer');

        // ▼ 신규: 옵션 엘리먼트
        const $risk = document.getElementById('stratRisk');

        // ▼ 전략 프리셋마다 권장 제약/설명을 매핑 (백엔드가 활용해도 됨)
        const STRATEGY_TEMPLATES = {
            barbell: {
                label: '바벨',
                note: '초저위험/초고위험을 양 끝단으로 배치, 중간 위험 제거. 현금/단기채 + 고변동 섹터/팩터.',
                constraints: {midRiskAssets: 'minimize', tailRiskBudget: 'allow'}
            },
            balanced: {
                label: '균형형',
                note: '주식/채권/대체 간 균형, 자산군 상관관계 고려한 리밸런스.',
                constraints: {targetVol: '8~12%', rebalance: 'quarterly'}
            },
            aggressive: {
                label: '공격적',
                note: '고베타/모멘텀/성장 비중 확대, 변동성/낙폭 허용.',
                constraints: {maxDrawdownTarget: '20~35%', betaBias: '>1.1'}
            },
            defensive: {
                label: '방어적',
                note: '저변동/가치/퀄리티 중심, 낙폭 축소 우선.',
                constraints: {maxDrawdownTarget: '<=15%', betaBias: '<0.9'}
            },
            value: {label: '가치', note: '저평가·현금흐름·배당 지표 우선.', constraints: {factorTilt: 'Value'}},
            growth: {label: '성장', note: '매출/이익 성장률·가이던스 상향 우선.', constraints: {factorTilt: 'Growth'}},
            dividend: {label: '배당', note: '배당수익률·증가·지속가능성.', constraints: {payoutPolicy: 'stable'}},
            momentum: {label: '모멘텀', note: '가격/실적 모멘텀 동행.', constraints: {lookback: '6~12M'}},
            quality: {label: '퀄리티', note: '수익성·안정성·재무건전성.', constraints: {filter: 'ROE/ROA/부채비율'}},
            riskParity: {label: '리스크 패리티', note: '기여 변동성 균등화.', constraints: {riskContribution: 'equal'}},
            dualMomentum: {label: '듀얼 모멘텀', note: '절대+상대 모멘텀 결합.', constraints: {cashOnWeakness: true}},
            hedged: {label: '헤지', note: '선물/옵션/인버스 등 하방 방어.', constraints: {hedgeRatio: '0~50%'}}
        };
        // 1) 값→라벨 매핑
        const LABELS = {
            barbell: '바벨', balanced: '균형형', riskParity: '리스크 패리티',
            aggressive: '공격적', defensive: '방어적', value: '가치', growth: '성장',
            dividend: '배당', momentum: '모멘텀', quality: '퀄리티',
            dualMomentum: '듀얼 모멘텀', hedged: '헤지'
        };

        // 2) 선택값 읽기(기존 getSelectedKinds 유지)
        function getSelectedKinds() {
            const menu = document.getElementById('stratKindsMenu');
            if (menu) {
                return Array.from(menu.querySelectorAll('input[name="stratKinds[]"]:checked'))
                    .map(i => i.value);
            }
            const sel = document.getElementById('stratKinds'); // 레거시 지원
            if (sel) return Array.from(sel.selectedOptions).map(o => o.value);
            return [];
        }

        // 3) 버튼 라벨 업데이트 + 초기화 버튼
        (function () {
            const menu = document.getElementById('stratKindsMenu');
            const btn = document.getElementById('stratKindsBtn');
            const clear = document.getElementById('kindsClear');

            function updateBtnLabel() {
                const vals = getSelectedKinds();
                btn.textContent = vals.length ? `전략 유형(${vals.length})` : '전략 유형 선택';
            }

            menu?.addEventListener('change', updateBtnLabel);
            clear?.addEventListener('click', () => {
                menu.querySelectorAll('input[name="stratKinds[]"]').forEach(i => i.checked = false);
                updateBtnLabel();
                // 변경 사항을 다른 UI에도 반영
                document.getElementById('stratKindsMenu')?.dispatchEvent(new Event('change'));
            });
            updateBtnLabel();
        })();

        // 4) 선택 뱃지 렌더링 + 뱃지 X버튼으로 개별 해제
        const pills = document.getElementById('kindsPills');

        function renderPills() {
            const vals = getSelectedKinds();
            pills.innerHTML = vals.map(v => `
    <span class="badge text-bg-light d-inline-flex align-items-center gap-1">
      ${LABELS[v] ?? v}
      <button type="button" class="btn-close btn-sm ms-1" data-kind="${v}" aria-label="제거"></button>
    </span>`).join('');
        }

        function clearStrategyOptionsUI() {
            // 1) 전략유형 체크박스 해제
            const menu = document.getElementById('stratKindsMenu');
            if (menu) {
                menu.querySelectorAll('input[name="stratKinds[]"]').forEach(i => i.checked = false);
                // 버튼 라벨/뱃지 갱신 트리거
                menu.dispatchEvent(new Event('change'));
            }

            // 2) 선택 뱃지 비우기
            const pills = document.getElementById('kindsPills');
            if (pills) pills.innerHTML = '';

            // 3) 리스크 기본값으로
            const risk = document.getElementById('stratRisk');
            if (risk) risk.value = 'moderate';
        }

// 버튼 클릭 바인딩
        document.getElementById('btnClearStrategyOptions')?.addEventListener('click', () => {
            clearStrategyOptionsUI();

            // (옵션) 알림 토스트
            try {
                const tc = document.querySelector('.toast-container');
                if (tc) {
                    const t = document.createElement('div');
                    t.className = 'toast align-items-center text-bg-secondary border-0 show';
                    t.innerHTML = `<div class='d-flex'><div class='toast-body'>전략 옵션을 초기화했어요.</div>
        <button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
                    tc.appendChild(t);
                    setTimeout(() => {
                        t.classList.replace('show', 'hide');
                        setTimeout(() => t.remove(), 300);
                    }, 1400);

                }

            } catch (_) {
            }
        });

        document.getElementById('stratKindsMenu')?.addEventListener('change', renderPills);
        pills?.addEventListener('click', (e) => {
            const kind = e.target?.dataset?.kind;
            if (!kind) return;
            // 체크 해제(토글)
            document.querySelector(`#stratKindsMenu input[value="${kind}"]`)?.click();
        });
        renderPills();

        // 간단 토스트 유틸(이미 ratio 쪽에 있으면 그걸 써도 됨)
        function toast(msg) {
            const tc = document.querySelector('.toast-container');
            const t = document.createElement('div');
            t.className = 'toast align-items-center text-bg-primary border-0 show';
            t.innerHTML = `<div class='d-flex'><div class='toast-body'>${msg}</div>
    <button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
            tc.appendChild(t);
            setTimeout(() => {
                t.classList.replace('show', 'hide');
                setTimeout(() => t.remove(), 300);
            }, 2000);
        }

        (function () {
            const menu = document.getElementById('stratKindsMenu');
            const MAX = 4;
            menu?.addEventListener('change', (e) => {
                const checked = menu.querySelectorAll('input[name="stratKinds[]"]:checked');
                if (checked.length > MAX) {
                    e.target.checked = false;
                    toast(`전략 유형은 최대 ${MAX}개까지 선택할 수 있어요.`);
                    // 상태 되돌렸으니 보조 UI 동기화
                    document.getElementById('stratKindsMenu')?.dispatchEvent(new Event('change'));
                }
            });
        })();
        // ▼ 리스크 성향별 가이드(백엔드 힌트)
        const RISK_PROFILE_HINT = {
            conservative: {targetVol: '5~8%', maxDrawdown: '<=12%', turnover: 'low'},
            moderate: {targetVol: '8~12%', maxDrawdown: '<=20%', turnover: 'mid'},
            aggressive: {targetVol: '12~18%', maxDrawdown: '<=35%', turnover: 'mid~high'}
        };

        // IIFE 끝부분에 추가 (전역으로 노출)
        window.getSelectedKinds = getSelectedKinds;
        window.STRATEGY_TEMPLATES = STRATEGY_TEMPLATES;
        window.RISK_PROFILE_HINT = RISK_PROFILE_HINT;


        // ▼ 사람이 읽기 좋은 “요약 프롬프트” 생성 (선택한 옵션을 자연어로 합성)
        function buildNaturalPrompt({prompt, kinds, risk, horizon, mode}) {
            const kLabels = kinds.map(k => STRATEGY_TEMPLATES[k]?.label || k).join(', ');
            const riskKo = {conservative: '보수적', moderate: '중립', aggressive: '공격적'}[risk] || risk;

            const hints = RISK_PROFILE_HINT[risk] || {};
            const unit = (mode === 'per' ? '기간' : '누적'); // 표시 단위만 남김

            const kindNotes = kinds
                .map(k => STRATEGY_TEMPLATES[k]?.note)
                .filter(Boolean)
                .map(n => `- ${n}`)
                .join('\n');

            return [
                `요청 전략: ${kLabels || '일반'} (${riskKo})`,
                `분석 구간: 최근 ${horizon === 'all' ? '전체' : horizon + '개월'} / 표시단위: ${unit}`,
                `리스크 가이드: 목표 변동성 ${hints.targetVol || '-'}, MDD ${hints.maxDrawdown || '-'}, 회전율 ${hints.turnover || '-'}`,
                kindNotes && `전략 노트:\n${kindNotes}`,
                prompt && `사용자 프롬프트: ${prompt}`
            ].filter(Boolean).join('\n');
        }

        // ▼ 백엔드로 넘길 payload
        function payload() {
            const kinds = getSelectedKinds();
            return {
                prompt: ($prompt?.value || '').trim(),
                horizon: $pnlRange?.value || '12',
                mode: ($modePer?.classList.contains('active') ? 'per' : 'cum'),
                strategy: {
                    kinds,                           // 예: ['barbell','aggressive']
                    risk: $risk?.value || 'moderate'
                    // leverageAllowed / hedgeAllowed 제거
                },
                // 힌트(선택): 서버가 프롬프트 엔지니어링에 쓰기 좋게 제공
                hints: {
                    riskProfile: RISK_PROFILE_HINT[$risk?.value || 'moderate'] || {},
                    templates: kinds.map(k => STRATEGY_TEMPLATES[k] || {label: k})
                },
                // 사람이 보기에 좋은 합성 프롬프트
                naturalPrompt: buildNaturalPrompt({
                    prompt: ($prompt?.value || '').trim(),
                    kinds,
                    risk: $risk?.value || 'moderate',
                    horizon: $pnlRange?.value || '12',
                    mode: ($modePer?.classList.contains('active') ? 'per' : 'cum')
                })
            };
        }

        function fire(type) {
            const detail = payload();
            document.dispatchEvent(new CustomEvent(type, {detail}));

            const title = (type === 'strategy:generate' ? '전략 생성'
                : type === 'strategy:riskAudit' ? '리스크 점검'
                    : '리밸런싱 제안');
        }

        document.getElementById('btnGenStrategy')?.addEventListener('click', () => fire('strategy:generate'));
        document.getElementById('btnRiskAudit')?.addEventListener('click', () => fire('strategy:riskAudit'));
        document.getElementById('btnRebalance')?.addEventListener('click', () => fire('strategy:rebalance'));
    })();

    // ===== Backend wiring placeholders =====
    document.addEventListener('strategy:generate', (e) => {
        // e.detail 구조 확인
        console.log('strategy:generate payload', e.detail);

        // 예시: 서버 호출
        // fetch('/api/strategy/generate', {
        //   method:'POST',
        //   headers:{'Content-Type':'application/json'},
        //   body: JSON.stringify(e.detail)
        // }).then(r=>r.json()).then(data=>{
        //   // genaiOutput.innerHTML = sanitize(data.html);
        // });
    });

    document.addEventListener('strategy:riskAudit', (e) => {
        console.log('strategy:riskAudit payload', e.detail);
        // TODO
    });
    document.addEventListener('strategy:rebalance', (e) => {
        console.log('strategy:rebalance payload', e.detail);
        // TODO
    });

    const $prompt = document.getElementById('prompt');
    const $log = document.getElementById('log');
    const $btn = document.getElementById('sendBtn');
    const $office = document.getElementById('officeCode');

    // URL ?brc=123456 있으면 officeCode에 자동 세팅
    (function initBrcFromUrl() {
        const sp = new URLSearchParams(location.search);
        const urlBrc = (sp.get('brc') || '').trim();
        if (urlBrc && $office) {
            $office.value = urlBrc.slice(0, 6).replace(/\D/g, '');
        }
    })();

    // ===== Chat helpers (define once, before append) =====
    window.escapeHtml = function (s = '') {
        return s
            .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    };
    window.linkify = function (s = '') {
        return s.replace(/\bhttps?:\/\/[^\s<>()]+/g,
            url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
    };
    window.formatBlocks = function (s = '') {
        s = s.replace(/```([\s\S]*?)```/g, (_, code) =>
            `<pre><code>${window.escapeHtml(code.trim())}</code></pre>`);
        s = s.replace(/`([^`]+?)`/g, (_, code) =>
            `<code>${window.escapeHtml(code)}</code>`);
        return s;
    };
    window.maybeClamp = function (html) {
        const MAX_LEN = 7000; // 길면 '더 보기' 토글
        if (html.length <= MAX_LEN) return html;
        const head = html.slice(0, MAX_LEN), tail = html.slice(MAX_LEN);
        const id = 'sx_' + Math.random().toString(36).slice(2);
        return `
    <span>${head}</span>
    <span id="${id}" style="display:none">${tail}</span>
    <a class="show-more" onclick="
      const h=document.getElementById('${id}');
      if(h.style.display==='none'){ this.textContent='간단히'; h.style.display='inline'; }
      else{ this.textContent='더 보기'; h.style.display='none'; }
    ">더 보기</a>`;
    };

    function nowHHMM() {
        const d = new Date();
        return d.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
    }

    function append(role, text) {
        const row = document.createElement('div');
        row.className = 'msg ' + (role || 'assistant');

        const av = document.createElement('div');
        av.className = 'avatar';
        av.textContent = role === 'user' ? '👤' : role === 'system' ? '⚙' : '🤖';

        const bb = document.createElement('div');
        bb.className = 'bubble';

        const safe = window.escapeHtml(text || '');
        const html = window.maybeClamp(window.linkify(window.formatBlocks(safe)));

        bb.innerHTML = `${html} <span class="meta">· ${nowHHMM()}</span>`;

        if (role === 'user') {
            row.appendChild(bb);
            row.appendChild(av);
        } else {
            row.appendChild(av);
            row.appendChild(bb);
        }

        $log.appendChild(row);
        $log.scrollTop = $log.scrollHeight;
    }

    function getBrc() {
        const v = ($office?.value || '').trim();
        return (v && /^\d{6}$/.test(v)) ? v : '707015';
    }

    async function fetchFinContext(brc, years = 5) {
        const url = `/api/finratio/serving/context?brc=${encodeURIComponent(brc)}&years=${years}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`컨텍스트 조회 실패: ${res.status}`);
        return await res.text();
    }


    function collectStrategyOptions() {
        // 1) 선택값 수집 (전역 노출 실패 대비해 DOM에서 직접 읽기)
        const kinds = Array.from(document.querySelectorAll('#stratKindsMenu input[name="stratKinds[]"]:checked'))
            .map(i => i.value);
        const risk = document.getElementById('stratRisk')?.value || 'moderate';
        const horizon = document.getElementById('pnlRange')?.value || '12';
        const mode = document.getElementById('pnlModePer')?.classList.contains('active') ? 'per' : 'cum';

        // 2) 전역 매핑(없어도 안전)
        const hints = (window.RISK_PROFILE_HINT?.[risk]) || {};
        const templates = (window.STRATEGY_TEMPLATES)
            ? kinds.map(k => window.STRATEGY_TEMPLATES[k] || {label: k})
            : kinds.map(k => ({label: k}));

        // 3) 자연어 요약(NOTE: 없는 경우 빈 문자열)
        const labels = (window.STRATEGY_TEMPLATES)
            ? kinds.map(k => window.STRATEGY_TEMPLATES[k]?.label || k)
            : kinds;
        const riskKo = {conservative: '보수적', moderate: '중립', aggressive: '공격적'}[risk] || risk;
        const naturalPrompt = [
            labels.length ? `요청 전략: ${labels.join(', ')} (${riskKo})` : '',
            `분석 구간: ${horizon === 'all' ? '전체' : horizon + '개월'} / 표시단위: ${mode === 'per' ? '기간' : '누적'}`,
            (hints && (hints.targetVol || hints.maxDrawdown || hints.turnover))
                ? `리스크 가이드: 변동성 ${hints.targetVol || '-'}, MDD ${hints.maxDrawdown || '-'}, 회전율 ${hints.turnover || '-'}`
                : ''
        ].filter(Boolean).join('\n');

        return {kinds, risk, horizon, mode, hints, templates, naturalPrompt};
    }

    async function buildMergedPromptAsync(userPrompt) {
        const brc = getBrc();
        const years = 5;

        // 전략 옵션 섹션 생성
        let stratSection = "";
        if (!skipStrategyOptions) {
            const strat = collectStrategyOptions();
            const stratJson = JSON.stringify(strat, null, 2);
            stratSection = `

[strategy_options.json]
${stratJson}`;
        } else {
            skipStrategyOptions = false; // 한 번만 생략
        }

        // 컨텍스트 가져오기 + 상태표시 갱신
        try {
            const ctx = await fetchFinContext(brc, years);
            const bytes = (typeof ctx === 'string') ? ctx.length : new Blob([ctx]).size;

            return `[client_vars]
brc: ${brc}
years: ${years}

[fin_ratio_serving]
${ctx}${stratSection}

[user_question]
${userPrompt}`;
        } catch (e) {
            // 컨텍스트 없을 때도 질문은 진행
            return `[client_vars]
brc: ${brc}${stratSection}

[user_question]
${userPrompt}`;
        }
    }


    // Enter로 전송 (Shift+Enter는 줄바꿈)
    $prompt.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            $btn.click();
        }
    });

    $btn.addEventListener('click', async () => {
        let prompt = $prompt.value;
        if (!prompt) {
            prompt = '전략 옵션 기반으로 분석해줘';
        }

        append('user', prompt);   // 화면에 실제 들어가는 값도 기본 프롬프트로
        $prompt.value = '';

        $btn.disabled = true;
        const old = $btn.textContent;
        $btn.textContent = '생각 중…';

        try {
            const mergedPrompt = await buildMergedPromptAsync(prompt);
            console.log("최종 mergedPrompt:", mergedPrompt);
            const res = await fetch('/api/ai/ask', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt: mergedPrompt})
            });
            if (!res.ok) {
                const t = await res.text();
                append('assistant', `오류: ${res.status} ${res.statusText}\n${t}`);
            } else {
                const data = await res.json();
                append('assistant', data?.answer || '(빈 응답)');
            }
        } catch (e) {
            append('assistant', '네트워크 오류: ' + e.message);
        } finally {
            $btn.disabled = false;
            $btn.textContent = old;
            $prompt.focus();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        const ta = document.getElementById('prompt');
        if (ta) ta.value = ''; // HTML에 들어간 들여쓰기/개행 제거
    });


    // === [추가] 전략 액션 버튼 색상(활성) 토글 ===
    (function attachStrategyActiveToggle() {
        const ids = ['btnGenStrategy', 'btnRiskAudit', 'btnRebalance'];
        const btns = ids.map(id => document.getElementById(id)).filter(Boolean);

        function activate(btn) {
            btns.forEach(b => {
                if (!b) return;
                // 모두 기본(회색)으로
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline-secondary');
            });
            // 클릭한 것만 파란색으로
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-primary');
        }

        btns.forEach(b => {
            if (!b) return;
            b.addEventListener('click', () => activate(b));
        });
    })();

    (function actionGuideWiring() {
        const $risk = document.getElementById('stratRisk');
        const $guide = document.getElementById('actionGuide');
        let lastAction = null; // 'generate' | 'risk' | 'rebalance' 중 최근 액션 저장

        const RISK_KO = {conservative: '보수적', moderate: '중립', aggressive: '공격적'};
        const ACTION_KO = {generate: '전략 생성', risk: '리스크 점검', rebalance: '리밸런싱 제안'};

        function setActionGuide(actionKey) {
            lastAction = actionKey;
            if (!$guide) return;
            const risk = $risk?.value || 'moderate';
            const riskKo = RISK_KO[risk] || risk;
            const actionKo = ACTION_KO[actionKey] || '';
            $guide.textContent = `${riskKo} ${actionKo}이 요청되었습니다. 보내기 버튼을 누르세요.`;
        }

        // 버튼 클릭 시 안내문 업데이트
        document.getElementById('btnGenStrategy')?.addEventListener('click', () => setActionGuide('generate'));
        document.getElementById('btnRiskAudit')?.addEventListener('click', () => setActionGuide('risk'));
        document.getElementById('btnRebalance')?.addEventListener('click', () => setActionGuide('rebalance'));

        // 리스크가 바뀌면, 마지막으로 눌렀던 액션 기준으로 문구만 갱신
        $risk?.addEventListener('change', () => {
            if (lastAction) setActionGuide(lastAction);
        });

        setActionGuide('generate');
    })();
</script>


</body>
</html>
