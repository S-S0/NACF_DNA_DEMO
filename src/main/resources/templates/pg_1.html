<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '주식 차트 · 재무비율 · 손익·위험 대시보드'">주식 차트 · 재무비율 · 손익·위험 대시보드</title>

    <!-- Bootstrap (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js & Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root{ --card-radius:8px; --shadow-sm:0 2px 4px rgba(0,0,0,.05); }
        body{display:flex;flex-direction:column;min-height:100vh;margin:0;overflow-x:hidden}
        header{background:#f8f9fa;padding:1rem;min-height:80px}
        main{flex:1;display:flex;justify-content:center;align-items:stretch}
        footer{background:#f8f9fa;padding:1rem;min-height:60px;text-align:center;font-size:.875rem;color:#6c757d}
        .logo-square{width:60px;height:60px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .logo-square img{width:100%;height:100%;object-fit:contain}
        .body-header{background:#f1f3f5;padding:.75rem 1rem;gap:.75rem}
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        input[type=number]{-moz-appearance:textfield}
        .content-container{width:100%;min-height:500px;max-height:calc(100vh - 190px);overflow:auto;border:1px solid #dee2e6;border-radius:var(--card-radius);padding:1rem;display:flex;flex-direction:column;background:#fff;box-shadow:var(--shadow-sm)}
        .corp-name{font-size:1.25rem;font-weight:700;margin-top:.5rem}
        .price-info{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}
        .price-big{font-size:1.5rem;font-weight:700}
        .price-label{font-size:1rem;color:#6c757d}
        .price-change.positive{color:#dc3545}
        .price-change.negative{color:#0d6efd}
        .change-badge{font-size:.85rem;padding:.125rem .5rem;border-radius:.5rem;line-height:1.2;display:inline-flex;align-items:center;gap:.25rem}
        .change-badge.up{color:#dc3545;background:rgba(220,53,69,.12)}
        .change-badge.down{color:#0d6efd;background:rgba(13,110,253,.12)}
        .change-badge.neutral{color:#6c757d;background:rgba(108,117,125,.12)}
        .candle-container{height:180px;flex:0 0 auto}
        .lower-box{flex:1 1 40%;overflow:auto}
        #custom_candle_chart{width:100%;height:100%}
        table.table td,table.table th{vertical-align:middle}
        #ratioTable tr:hover{background:#f8f9fa;cursor:pointer}
        .table-responsive thead th{position:sticky;top:0;background:#f8f9fa;z-index:2}
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:1080}
        .chart-wrapper{height:300px}
        #stockChart{width:100%!important;height:100%!important}
        .factor-card{background:#f8f9fa;border-radius:var(--card-radius)}
        .factor-body{background:#ffffff;border:1px solid #dee2e6;border-radius:var(--card-radius);padding:1rem;box-shadow:var(--shadow-sm)}
        #factorChart{width:100%!important;height:240px!important}
        .sub-divider{border-top:1px solid #dee2e6;height:1px;margin:.25rem 0 .75rem}
        .mini-card{background:#fff;border:1px solid #e9ecef;border-radius:var(--card-radius);box-shadow:var(--shadow-sm)}
        .mini-card-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid #f1f3f5}
        .mini-card-title{font-weight:700;font-size:.95rem;margin:0}
        .mini-card-body{padding:.75rem;height:260px}
        .mini-card-body canvas{width:100%!important;height:100%!important}
        .outlook-card{background:#fff;border:1px solid #e9ecef;border-radius:var(--card-radius);box-shadow:var(--shadow-sm);margin-top:.75rem;overflow:hidden}
        .outlook-header{display:flex;align-items:center;gap:.5rem;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid #f1f3f5}
        .outlook-title{font-weight:700;font-size:.95rem;margin:0}
        .outlook-tabs .btn{padding:.15rem .5rem;font-size:.8rem}
        .outlook-body{padding:.5rem;height:280px;position:relative}
        .outlook-body canvas{width:100%!important;height:100%!important}
        .risk-kpi{background:#fff;border:1px solid #e9ecef;border-radius:8px;padding:.75rem;box-shadow:var(--shadow-sm)}
        .risk-kpi-label{font-size:.85rem;color:#6c757d}
        .risk-kpi-value{font-weight:800;font-size:1.25rem;letter-spacing:.2px}
    </style>
</head>
<body>
<header class="container-fluid d-flex align-items-center gap-3">
    <div class="logo-square">
        <img th:src="@{/img/nh_symbol.gif}" src="/img/nh_symbol.gif" alt="NH 로고" loading="lazy">
    </div>
    <h1 class="h4 mb-0" th:text="${pageTitle} ?: '재무 대시보드'">재무 대시보드</h1>
</header>

<div class="body-header container-fluid d-flex align-items-center flex-wrap">
    <label class="form-label mb-0 fw-bold" for="officeCode">사무소코드</label>
    <input id="officeCode" type="number" inputmode="numeric" pattern="[0-9]*" maxlength="6"
           class="form-control form-control-sm" placeholder="6자리 숫자" style="max-width:150px"
           aria-describedby="officeHelp"
           oninput="if(this.value.length>6)this.value=this.value.slice(0,6);">
    <small id="officeHelp" class="text-muted ms-1">숫자 6자리</small>
    <button class="btn btn-sm btn-primary" type="button">확인</button>
</div>

<main class="container-fluid py-2">
    <div class="content-container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#main" role="tab">메인</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ratio" role="tab">재무비율</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#profit" role="tab">손익/위험</button></li>
        </ul>

        <div class="corp-name" th:text="${brcInfos[0]?.brnm} ?: 'XX농협'"></div>

        <div class="tab-content mt-3">
            <!-- Main -->
            <div id="main" class="tab-pane fade show active" role="tabpanel">
                <div class="row g-3">
                    <aside class="col-lg-3 col-md-4">
                        <div class="d-flex flex-column gap-3 h-100">
                            <section class="p-3 border bg-light rounded-2" aria-labelledby="priceIntroTitle">
                                <div class="price-info" id="priceIntroTitle" aria-label="현재 가격 정보">
                                    <span class="price-big" id="price-now" th:text="${#numbers.formatInteger(quote?.price ?: 22500, 0)}">22,500</span>
                                    <span class="price-label" id="price-ccy" th:text="${quote?.currency} ?: 'KRW'">KRW</span>
                                    <span class="price-change visually-hidden"
                                          th:classappend="${(quote?.changePercent ?: 0) &gt;= 0} ? ' positive' : ' negative'"
                                          th:text="${(quote?.changePercent) != null ? #numbers.formatDecimal(quote.changePercent, 1, 2) + '%' : '-0.56% ▼ ₩500'}">-0.56% ▼ ₩500</span>
                                    <span id="price-change-pct" class="change-badge" aria-label="전일 대비 등락률">--%</span>
                                    <span id="price-change-abs" class="change-badge" aria-label="전일 대비 금액">--</span>
                                </div>
                                <div class="mt-3">
                                    <h2 class="h6 fw-bold mb-1">소개</h2>
                                    <hr class="mt-0 mb-2">
                                    <p class="mb-0" style="font-size:0.9rem" th:text="${brcInfos[0]?.description} ?: '여기에 회사 소개 글을 입력하세요.'">
                                    </p>
                                </div>
                            </section>

                            <section class="p-3 factor-card border rounded-2 flex-grow-1" aria-labelledby="factorTitle">
                                <div class="d-flex align-items-center mb-2">
                                    <h2 id="factorTitle" class="h6 fw-bold mb-0">팩터 분석</h2>
                                    <button class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1" type="button" data-bs-toggle="tooltip" title="6대 팩터(변동성·밸류·사이즈·모멘텀·베타·전망치) 상대 점수(0~100)"><span style="font-size:.85rem">❔</span></button>
                                </div>
                                <div class="factor-body"><canvas id="factorChart" aria-label="팩터 분석 차트" role="img"></canvas></div>
                            </section>
                        </div>
                    </aside>

                    <div class="col-lg-9 col-md-8">
                        <section class="p-3 border bg-white rounded-2 h-100 d-flex flex-column">
                            <div class="candle-container border-bottom p-2">
                                <div id="custom_candle_chart" aria-label="캔들 차트" role="img"></div>
                            </div>

                            <section class="outlook-card" aria-labelledby="outlookTitle">
                                <div class="outlook-header">
                                    <div class="d-flex align-items-center gap-2">
                                        <h3 id="outlookTitle" class="outlook-title mb-0">전문가 전망치</h3>
                                        <span class="text-muted" data-bs-toggle="tooltip" title="애널리스트 목표가 기준 12개월 전망">❔</span>
                                    </div>
                                    <div class="outlook-tabs btn-group btn-group-sm" role="group">
                                        <button class="btn btn-success active" type="button" disabled>12개월 전망</button>
                                        <button class="btn btn-outline-secondary" type="button" disabled>전망 분포</button>
                                        <button class="btn btn-outline-secondary" type="button" disabled>전망치 추이</button>
                                    </div>
                                </div>
                                <div class="outlook-body">
                                    <canvas id="outlookChart"></canvas>
                                </div>
                            </section>

                            <div class="lower-box p-2">
                                <div class="sub-divider" role="separator" aria-label="보조 지표 구분선"></div>
                                <div class="row g-3">
                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">매출액 구성</h3>
                                                <div class="btn-group btn-group-sm" role="group" aria-label="값 보기 전환">
                                                    <button id="mixAbsBtn" type="button" class="btn btn-outline-secondary active">절대값</button>
                                                    <button id="mixPctBtn" type="button" class="btn btn-outline-secondary">비율화</button>
                                                </div>
                                            </div>
                                            <div class="mini-card-body"><canvas id="salesMixChart"></canvas></div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">이익률</h3>
                                            </div>
                                            <div class="mini-card-body"><canvas id="profitRateChart"></canvas></div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">이익성장률 (YoY)</h3>
                                            </div>
                                            <div class="mini-card-body"><canvas id="growthChart"></canvas></div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<footer>© <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span> 재무 대시보드</footer>
<div class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Inline App Script -->
<script th:inline="javascript">
    /* ===== Bootstrap Tooltip ===== */
    (function(){
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){ new bootstrap.Tooltip(el); });
    })();

    /* ===== Zoom plugin: register once (robust) ===== */
    (function(){
        if (!window.Chart) return;
        const zoom = window['chartjs-plugin-zoom'];
        try { if (zoom) { Chart.register(zoom); } } catch(_) { /* already registered */ }
    })();

    /* ===== Data from server (with fallbacks) ===== */
    const YEARS  = /*[[${years}]]*/ ["FY2021","FY2022","FY2023","FY2024","FY2025"];

    /* FACTOR: 서버가 [숫자...] 또는 [{volatility,...}] 둘 다 줄 수 있어 통일 */
    const _RAW_FACTOR = /*[[${factorScores}]]*/ [];
    function normalizeFactor(raw){
        if (!Array.isArray(raw) || raw.length === 0) return [0,0,0,0,0,0];
        // 케이스1) [숫자, ...] 6개
        if (typeof raw[0] === 'number') {
            return (raw.length >= 6) ? raw.slice(0,6) : [...raw, ...Array(6-raw.length).fill(0)];
        }
        // 케이스2) [{ volatility,valueFactor,sizeFactor,momentum,beta,outlook }]
        const o = raw[0] || {};
        return [
            +o.volatility   || 0,
            +o.valueFactor  || 0,
            +o.sizeFactor   || 0,
            +o.momentum     || 0,
            +o.beta         || 0,
            +o.outlook      || 0
        ];
    }
    const FACTOR_DATA = normalizeFactor(_RAW_FACTOR);

    /* ===== Radar Chart for factor ===== */
    (function(){
        const canvas = document.getElementById('factorChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d'); if (!ctx) return;

        new Chart(ctx, {
            type:'radar',
            data:{
                labels:['변동성','밸류','사이즈','모멘텀','베타','전망치'],
                datasets:[{
                    label:'팩터 점수',
                    data: FACTOR_DATA,
                    backgroundColor:'rgba(54,162,235,0.2)',
                    borderColor:'rgba(54,162,235,1)',
                    pointBackgroundColor:'rgba(54,162,235,1)',
                    pointRadius:3,
                    fill:true,
                    tension:0.25
                }]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{ legend:{display:false} },
                scales:{ r:{ beginAtZero:true, min:0, max:100, ticks:{stepSize:20}, angleLines:{color:'#eee'}, grid:{color:'#ddd'} } }
            }
        });
    })();

    // 주가
    const STOCKS = /*[[${stockPrices}]]*/ [];

    /* LightweightCharts에 맞게 변환 (YYYYMMDD → YYYY-MM-DD, 숫자 가드) */
    const CANDLES = STOCKS.map(d => {
        const s = String(d?.basDt ?? '');
        const time = (s.length === 8) ? `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`
            : (d?.basDt ?? '');
        return {
            time,
            open : +d?.open  || 0,
            high : +d?.high  || 0,
            low  : +d?.low   || 0,
            close: +d?.close || 0
        };
    });

    // 전망치

    /* ===== Candlestick (Lightweight) + Outlook (Chart.js) ===== */
    (function(){
        const el=document.getElementById('custom_candle_chart');
        if(!window.LightweightCharts || !el){ return; }
        const chart=LightweightCharts.createChart(el,{
            width:el.clientWidth,height:el.clientHeight,
            layout:{background:{type:'solid',color:'#fff'},textColor:'#333'},
            grid:{vertLines:{color:'#eee'},horzLines:{color:'#eee'}},
            rightPriceScale:{visible:true},timeScale:{borderColor:'#eee',timeVisible:true}
        });
        chart.addCandlestickSeries({upColor:'#26a69a',downColor:'#ef5350',wickUpColor:'#26a69a',wickDownColor:'#ef5350'}).setData(CANDLES);
        chart.timeScale().fitContent();

        const ro = new ResizeObserver(entries=>{
            const {width, height} = entries[0].contentRect;
            chart.resize(Math.max(50, Math.floor(width)), Math.max(100, Math.floor(height)));
        });
        ro.observe(el);
        window.addEventListener('resize',()=>chart.resize(el.clientWidth,el.clientHeight));
        requestAnimationFrame(()=>chart.resize(el.clientWidth,el.clientHeight));

        const profitBtn = document.querySelector('[data-bs-target="#main"]');
        profitBtn?.addEventListener('shown.bs.tab',()=>{
            chart.resize(el.clientWidth,el.clientHeight);
            chart.timeScale().fitContent();
            requestAnimationFrame(()=> window._outlookChart?.resize?.());
        });

        const canvas = document.getElementById('outlookChart');
        if (!canvas) return;
        const outlookCtx = canvas.getContext('2d'); if(!outlookCtx) return;
        const nf = new Intl.NumberFormat('ko-KR');

        const lastClose = CANDLES[CANDLES.length-1].close;
        const target = { max: 36000, avg: 29875, min: 21000 }; //To-Do 전망치
        const history = CANDLES.map(d=>d.close);
        const labels  = CANDLES.map(d=>d.time).concat(['12개월 후']);
        const histData = history.concat([null]);
        const projBase = new Array(history.length-1).fill(null);
        const projMax  = projBase.concat([lastClose, target.max]);
        const projAvg  = projBase.concat([lastClose, target.avg]);
        const projMin  = projBase.concat([lastClose, target.min]);

        const allVals = history.concat([target.min, target.max]);
        const yMin = Math.min(...allVals);
        const yMax = Math.max(...allVals);
        const pad  = Math.max(100, (yMax - yMin) * 0.1);

        const outlookLabel = {
            id:'outlookLabel',
            afterDatasetsDraw(chart){
                const {ctx, scales, chartArea} = chart;
                const x = scales?.x, y = scales?.y;
                if (!x || !y || !chartArea) return;
                const {top, bottom} = chartArea;
                const endIndex = labels.length-1;
                ctx.save();

                function roundRect(ctx,x,y,w,h,r){
                    ctx.beginPath();
                    ctx.moveTo(x+r,y);
                    ctx.arcTo(x+w,y,x+w,y+h,r);
                    ctx.arcTo(x+w,y+h,x,y+h,r);
                    ctx.arcTo(x,y+h,x,y,r);
                    ctx.arcTo(x,y,x+w,y,r);
                    ctx.closePath();
                }
                function drawTag(yVal, text, color){
                    const xEnd = x.getPixelForValue(endIndex);
                    const yEnd = y.getPixelForValue(yVal);
                    const padX=8; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
                    const metrics = ctx.measureText(text); const boxW=metrics.width+padX*2, boxH=22;
                    const rx=6; const bx = Math.min(chart.width - boxW - 4, xEnd + 6);
                    const by = Math.min(Math.max(yEnd - boxH/2, top + 2), bottom - boxH - 2);
                    ctx.fillStyle = '#fff'; ctx.strokeStyle = color; ctx.lineWidth=1.2;
                    roundRect(ctx, bx, by, boxW, boxH, rx); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = color; ctx.fillText(text, bx+padX, by+boxH/1.5);
                }
                const p = (v)=>{ const diff=v-lastClose; const sign = diff>0? '+':'-'; return `${diff===0?'±':sign}${Math.abs(diff/lastClose*100).toFixed(2)}%  ₩${nf.format(v)}`; };
                drawTag(target.max, `최고 ${p(target.max)}`, '#198754'); //To-Do
                drawTag(target.avg, `평균 ${p(target.avg)}`, '#198754'); //To-Do
                drawTag(target.min, `최저 ${p(target.min)}`, '#dc3545'); //To-Do

                const xNow = x.getPixelForValue(labels.length-2);
                const yNow = y.getPixelForValue(lastClose);
                ctx.fillStyle = '#212529'; ctx.beginPath(); ctx.arc(xNow, yNow, 4, 0, Math.PI*2); ctx.fill();
                const nowText = `현재가 ₩${nf.format(lastClose)}`; //To-Do
                const m = ctx.measureText(nowText); const w=m.width + 16, h=20; const rx=6;
                const nx = Math.max(Math.min(xNow - w - 8, chart.width - w - 4), 8);
                const ny = Math.min(Math.max(yNow - h/2, top + 2), bottom - h - 2);
                ctx.fillStyle='#fff'; ctx.strokeStyle='#6c757d'; ctx.lineWidth=1; roundRect(ctx,nx,ny,w,h,rx); ctx.fill(); ctx.stroke();
                ctx.fillStyle='#6c757d'; ctx.fillText(nowText, nx+8, ny+h/1.5);
                ctx.restore();
            }
        };

        const grad = outlookCtx.createLinearGradient(0,0,0,280);
        grad.addColorStop(0,'rgba(43,47,54,0.15)');
        grad.addColorStop(1,'rgba(43,47,54,0.00)');

        window._outlookChart = new Chart(outlookCtx, {
            plugins: [outlookLabel],
            type:'line',
            data:{ labels, datasets:[
                    { label:'과거', data: histData, borderWidth:1.5, pointRadius:0, tension:.25, borderColor:'#2b2f36', fill:true, backgroundColor:grad },
                    { label:'최고', data: projMax, borderColor:'#198754', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#198754', tension:.15, spanGaps:true },
                    { label:'평균', data: projAvg, borderColor:'#20c997', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#20c997', tension:.15, spanGaps:true },
                    { label:'최저', data: projMin, borderColor:'#dc3545', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#dc3545', tension:.15, spanGaps:true }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                interaction:{ intersect:false, mode:'nearest' },
                plugins:{
                    legend:{display:false},
                    tooltip:{ enabled:true, callbacks:{ label:(c)=> '₩'+nf.format(c.parsed.y) } },
                    zoom:{ pan:{enabled:true,mode:'x'}, zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' } }
                },
                layout:{ padding:{ right: 160 } },
                scales:{
                    x:{ grid:{display:false}, ticks:{ maxRotation:0, autoSkip:true } },
                    y:{ min: yMin - pad, max: yMax + pad, ticks:{ callback:v=>'₩'+nf.format(v) } }
                }
            }
        });
    })();

    /* ===== Price header dynamic badges ===== */
    (function(){
        const nowEl=document.getElementById('price-now');
        const pctEl=document.getElementById('price-change-pct');
        const absEl=document.getElementById('price-change-abs');
        if(!nowEl||!pctEl||!absEl||!Array.isArray(CANDLES)||CANDLES.length<2) return;
        const last=CANDLES[CANDLES.length-1].close;
        const prev=CANDLES[CANDLES.length-2].close;
        const diff=last-prev;
        const pct=prev? (diff/prev*100):0;
        const nf=new Intl.NumberFormat('ko-KR');
        const sign= diff>0? '▲' : diff<0? '▼' : '—';
        const dir = diff>0? 'up' : diff<0? 'down' : 'neutral';
        nowEl.textContent=nf.format(last);
        pctEl.textContent=`${sign} ${Math.abs(pct).toFixed(2)}%`;
        absEl.textContent=`${sign} ₩${nf.format(Math.abs(diff))}`;
        [pctEl,absEl].forEach(el=>{ el.classList.remove('up','down','neutral'); el.classList.add(dir); });
    })();

    /* ===== Support Charts (Sales Mix / Profit Rate / Growth) ===== */
    // 매출액 구성
    (function(){
        const nf = new Intl.NumberFormat('ko-KR');
        const years=['2022','2023','2024']; //To-Do
        const UNIT = 1000000; // 1백만 단위

        const INCOMES = /*[[${incomePrices}]]*/ [];
        console.log("INCOMES", INCOMES);  // 배열이면 OK

        function toPctStacks(stacks){
            const totals = years.map((_,i)=> stacks.reduce((s,st)=>s+(st.data[i]||0),0));
            return stacks.map(st=>({label:st.label, data:st.data.map((v,i)=> totals[i]? +(v/totals[i]*100).toFixed(2):0)}));
        }

        const mixDataAbs={
            labels: years,
            stacks: [      // 데이터 임시적용, 항목정해야하고 금액크기 변환필요
                { label: '이자비용', data: INCOMES.map(i => i.totalAssets) },
                { label: '대손충당금', data: INCOMES.map(i => i.depositTotal) },
                { label: '이자외비용', data: INCOMES.map(i => i.interestIncome) }
//                {label:'세전당기손익', data:[280,460,620]},
//                {label:'이자수익+이자외수익', data:[700,980,1200]}
            ],
            line:{label:'순이자마진', data:[2.3,2.1,2.4]}
        };
        const mixDataPct = { labels:years, stacks: toPctStacks(mixDataAbs.stacks), line: mixDataAbs.line };

        const stackedBarOpts=(isPct=false)=>({
            responsive:true, maintainAspectRatio:false,
            scales:{
                x:{ stacked:true },
                y:{ stacked:true, position:'left', beginAtZero:true,
                    ticks:{ callback:v=> isPct? v+'%': '₩'+nf.format(v) } },
                y2:{ position:'right', beginAtZero:true, min:0, max: (isPct? 100: 3),
                    grid:{ drawOnChartArea:false }, ticks:{ callback:v=> v+'%' } }
            },
            plugins:{ legend:{position:'bottom'} }
        });

        const mixCtx=document.getElementById('salesMixChart')?.getContext('2d'); if(!mixCtx) return;
        let mixMode='abs';
        const mixChart=new Chart(mixCtx,{
            type:'bar',
            data:{ labels:mixDataAbs.labels, datasets:[
                    ...mixDataAbs.stacks.map(st=>({ type:'bar',label:st.label,data:st.data,stack:'stack',order:2 })),
                    { type:'line', label:mixDataAbs.line.label, data:mixDataAbs.line.data, yAxisID:'y2', order:1, tension:.3, pointRadius:2 }
                ]},
            options: stackedBarOpts(false)
        });
        function switchMix(mode){
            if(mixMode===mode) return; mixMode=mode;
            const isPct = mode==='pct';
            const use = isPct? mixDataPct : mixDataAbs;
            mixChart.data.labels = use.labels;
            for(let i=0;i<use.stacks.length;i++){
                mixChart.data.datasets[i].data = use.stacks[i].data;
                mixChart.data.datasets[i].type='bar';
                mixChart.data.datasets[i].yAxisID='y';
                mixChart.data.datasets[i].stack='stack';
            }
            mixChart.data.datasets[use.stacks.length] = {
                ...mixChart.data.datasets[use.stacks.length],
                type:'line', data: use.line.data, yAxisID:'y2', order:1
            };
            mixChart.options = stackedBarOpts(isPct);
            mixChart.update();
            document.getElementById('mixAbsBtn').classList.toggle('active', !isPct);
            document.getElementById('mixPctBtn').classList.toggle('active', isPct);
        }
        document.getElementById('mixAbsBtn')?.addEventListener('click',()=>switchMix('abs'));
        document.getElementById('mixPctBtn')?.addEventListener('click',()=>switchMix('pct'));

        // 두번째 차트
        const PROFITS = /*[[${profitMargins}]]*/ [];
        console.log("PROFITS", PROFITS);  // 배열이면 OK

        const prCtx=document.getElementById('profitRateChart')?.getContext('2d'); if(!prCtx) return;
        new Chart(prCtx,{
            type:'bar',
            data:{ labels:years, datasets:[
                    { type:'bar', label:'이자수익+이자외수익', data: PROFITS.map(i => i.totalAssets), order:2 },
                    { type:'line', label:'세전손익률', data: PROFITS.map(i => i.depositTotal), yAxisID:'y2', order:1, tension:.3, pointRadius:2 },
                    { type:'line', label:'순이익률', data: PROFITS.map(i => i.interestIncome), yAxisID:'y2', order:1, tension:.3, pointRadius:2 }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{
                    y:{ beginAtZero:true, ticks:{ callback:v=>'₩'+new Intl.NumberFormat('ko-KR').format(v) } },
                    y2:{ position:'right', beginAtZero:true, min:0, max:25, grid:{ drawOnChartArea:false }, ticks:{ callback:v=>v+'%' } }
                },
                plugins:{ legend:{position:'bottom'} }
            }
        });
        // 세번째 차트
        const PROGROWTH = /*[[${profitGrowths}]]*/ [];
        console.log("PROGROWTH", PROGROWTH);  // 배열이면 OK

        const grCtx=document.getElementById('growthChart')?.getContext('2d'); if(!grCtx) return;
        new Chart(grCtx,{
            type:'line',
            data:{ labels:years, datasets:[
                    { label:'순이자수익성장률', data:PROGROWTH.map(i => i.totalAssets), tension:.3, pointRadius:2 },
                    { label:'대손충당금 차감 후 순이자수익', data:PROGROWTH.map(i => i.totalAssets), tension:.3, pointRadius:2 },
                    { label:'세전당기손익성장률', data:PROGROWTH.map(i => i.depositTotal), tension:.3, pointRadius:2 },
                    { label:'순이익성장률', data:PROGROWTH.map(i => i.interestIncome), tension:.3, pointRadius:2 }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v+'%' } } },
                plugins:{ legend:{position:'bottom'} }
            }
        });
    })();



    // ===== Backend wiring placeholders =====
    document.addEventListener('strategy:generate', (e)=>{
        // e.detail 구조 확인
//        console.log('strategy:generate payload', e.detail);

        // 예시: 서버 호출
        // fetch('/api/strategy/generate', {
        //   method:'POST',
        //   headers:{'Content-Type':'application/json'},
        //   body: JSON.stringify(e.detail)
        // }).then(r=>r.json()).then(data=>{
        //   // genaiOutput.innerHTML = sanitize(data.html);
        // });
    });

    document.addEventListener('strategy:riskAudit', (e)=>{
//        console.log('strategy:riskAudit payload', e.detail);
        // TODO
    });
    document.addEventListener('strategy:rebalance', (e)=>{
//        console.log('strategy:rebalance payload', e.detail);
        // TODO
    });
</script>
</body>
</html>
