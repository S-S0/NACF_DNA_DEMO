<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '주식 차트 · 재무비율 · 손익·위험 대시보드'">주식 차트 · 재무비율 · 손익·위험 대시보드</title>

    <!-- Bootstrap (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js & Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root{ --card-radius:8px; --shadow-sm:0 2px 4px rgba(0,0,0,.05); }
        body{display:flex;flex-direction:column;min-height:100vh;margin:0;overflow-x:hidden}
        header{background:#f8f9fa;padding:1rem;min-height:80px}
        main{flex:1;display:flex;justify-content:center;align-items:stretch}
        footer{background:#f8f9fa;padding:1rem;min-height:60px;text-align:center;font-size:.875rem;color:#6c757d}
        .logo-square{width:60px;height:60px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .logo-square img{width:100%;height:100%;object-fit:contain}
        .body-header{background:#f1f3f5;padding:.75rem 1rem;gap:.75rem}
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        input[type=number]{-moz-appearance:textfield}
        .content-container{width:100%;min-height:500px;max-height:calc(100vh - 190px);overflow:auto;border:1px solid #dee2e6;border-radius:var(--card-radius);padding:1rem;display:flex;flex-direction:column;background:#fff;box-shadow:var(--shadow-sm)}
        .corp-name{font-size:1.25rem;font-weight:700;margin-top:.5rem}
        .price-info{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}
        .price-big{font-size:1.5rem;font-weight:700}
        .price-label{font-size:1rem;color:#6c757d}
        .price-change.positive{color:#dc3545}
        .price-change.negative{color:#0d6efd}
        .change-badge{font-size:.85rem;padding:.125rem .5rem;border-radius:.5rem;line-height:1.2;display:inline-flex;align-items:center;gap:.25rem}
        .change-badge.up{color:#dc3545;background:rgba(220,53,69,.12)}
        .change-badge.down{color:#0d6efd;background:rgba(13,110,253,.12)}
        .change-badge.neutral{color:#6c757d;background:rgba(108,117,125,.12)}
        .candle-container{height:180px;flex:0 0 auto}
        .lower-box{flex:1 1 40%;overflow:auto}
        #custom_candle_chart{width:100%;height:100%}
        table.table td,table.table th{vertical-align:middle}
        #ratioTable tr:hover{background:#f8f9fa;cursor:pointer}
        .table-responsive thead th{position:sticky;top:0;background:#f8f9fa;z-index:2}
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:1080}
        .chart-wrapper{height:300px}
        #stockChart{width:100%!important;height:100%!important}
        .factor-card{background:#f8f9fa;border-radius:var(--card-radius)}
        .factor-body{background:#ffffff;border:1px solid #dee2e6;border-radius:var(--card-radius);padding:1rem;box-shadow:var(--shadow-sm)}
        #factorChart{width:100%!important;height:240px!important}
        .sub-divider{border-top:1px solid #dee2e6;height:1px;margin:.25rem 0 .75rem}
        .mini-card{background:#fff;border:1px solid #e9ecef;border-radius:var(--card-radius);box-shadow:var(--shadow-sm)}
        .mini-card-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid #f1f3f5}
        .mini-card-title{font-weight:700;font-size:.95rem;margin:0}
        .mini-card-body{padding:.75rem;height:260px}
        .mini-card-body canvas{width:100%!important;height:100%!important}
        .outlook-card{background:#fff;border:1px solid #e9ecef;border-radius:var(--card-radius);box-shadow:var(--shadow-sm);margin-top:.75rem;overflow:hidden}
        .outlook-header{display:flex;align-items:center;gap:.5rem;justify-content:space-between;padding:.5rem .75rem;border-bottom:1px solid #f1f3f5}
        .outlook-title{font-weight:700;font-size:.95rem;margin:0}
        .outlook-tabs .btn{padding:.15rem .5rem;font-size:.8rem}
        .outlook-body{padding:.5rem;height:280px;position:relative}
        .outlook-body canvas{width:100%!important;height:100%!important}
        .risk-kpi{background:#fff;border:1px solid #e9ecef;border-radius:8px;padding:.75rem;box-shadow:var(--shadow-sm)}
        .risk-kpi-label{font-size:.85rem;color:#6c757d}
        .risk-kpi-value{font-weight:800;font-size:1.25rem;letter-spacing:.2px}
    </style>
</head>
<body>
<header class="container-fluid d-flex align-items-center gap-3">
    <div class="logo-square">
        <img th:src="@{/img/nh_symbol.gif}" src="/img/nh_symbol.gif" alt="NH 로고" loading="lazy">
    </div>
    <h1 class="h4 mb-0" th:text="${pageTitle} ?: '재무 대시보드'">재무 대시보드</h1>
</header>

<div class="body-header container-fluid d-flex align-items-center flex-wrap">
    <label class="form-label mb-0 fw-bold" for="officeCode">사무소코드</label>
    <input id="officeCode" type="number" inputmode="numeric" pattern="[0-9]*" maxlength="6"
           class="form-control form-control-sm" placeholder="6자리 숫자" style="max-width:150px"
           aria-describedby="officeHelp"
           oninput="if(this.value.length>6)this.value=this.value.slice(0,6);">
    <small id="officeHelp" class="text-muted ms-1">숫자 6자리</small>
    <button class="btn btn-sm btn-primary" type="button">확인</button>
</div>

<main class="container-fluid py-2">
    <div class="content-container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#main" role="tab">메인</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ratio" role="tab">재무비율</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#profit" role="tab">손익/위험</button></li>
        </ul>

        <div class="corp-name" th:text="${corp?.name} ?: 'XX농협'">XX농협</div>

        <div class="tab-content mt-3">
            <!-- Main -->
            <div id="main" class="tab-pane fade show active" role="tabpanel">
                <div class="row g-3">
                    <aside class="col-lg-3 col-md-4">
                        <div class="d-flex flex-column gap-3 h-100">
                            <section class="p-3 border bg-light rounded-2" aria-labelledby="priceIntroTitle">
                                <div class="price-info" id="priceIntroTitle" aria-label="현재 가격 정보">
                                    <span class="price-big" id="price-now" th:text="${#numbers.formatInteger(quote?.price ?: 22500, 0)}">22,500</span>
                                    <span class="price-label" id="price-ccy" th:text="${quote?.currency} ?: 'KRW'">KRW</span>
                                    <span class="price-change visually-hidden"
                                          th:classappend="${(quote?.changePercent ?: 0) &gt;= 0} ? ' positive' : ' negative'"
                                          th:text="${(quote?.changePercent) != null ? #numbers.formatDecimal(quote.changePercent, 1, 2) + '%' : '-0.56% ▼ ₩500'}">-0.56% ▼ ₩500</span>
                                    <span id="price-change-pct" class="change-badge" aria-label="전일 대비 등락률">--%</span>
                                    <span id="price-change-abs" class="change-badge" aria-label="전일 대비 금액">--</span>
                                </div>
                                <div class="mt-3">
                                    <h2 class="h6 fw-bold mb-1">소개</h2>
                                    <hr class="mt-0 mb-2">
                                    <p class="mb-0" style="font-size:0.9rem" th:text="${corp?.intro} ?: '여기에 회사 소개 글을 입력하세요.'">
                                        여기에 회사 소개 글을 입력하세요.
                                    </p>
                                </div>
                            </section>

                            <section class="p-3 factor-card border rounded-2 flex-grow-1" aria-labelledby="factorTitle">
                                <div class="d-flex align-items-center mb-2">
                                    <h2 id="factorTitle" class="h6 fw-bold mb-0">팩터 분석</h2>
                                    <button class="btn btn-sm btn-outline-secondary ms-2 py-0 px-1" type="button" data-bs-toggle="tooltip" title="6대 팩터(변동성·밸류·사이즈·모멘텀·베타·전망치) 상대 점수(0~100)"><span style="font-size:.85rem">❔</span></button>
                                </div>
                                <div class="factor-body"><canvas id="factorChart" aria-label="팩터 분석 차트" role="img"></canvas></div>
                            </section>
                        </div>
                    </aside>

                    <div class="col-lg-9 col-md-8">
                        <section class="p-3 border bg-white rounded-2 h-100 d-flex flex-column">
                            <div class="candle-container border-bottom p-2">
                                <div id="custom_candle_chart" aria-label="캔들 차트" role="img"></div>
                            </div>

                            <section class="outlook-card" aria-labelledby="outlookTitle">
                                <div class="outlook-header">
                                    <div class="d-flex align-items-center gap-2">
                                        <h3 id="outlookTitle" class="outlook-title mb-0">전문가 전망치</h3>
                                        <span class="text-muted" data-bs-toggle="tooltip" title="애널리스트 목표가 기준 12개월 전망">❔</span>
                                    </div>
                                    <div class="outlook-tabs btn-group btn-group-sm" role="group">
                                        <button class="btn btn-success active" type="button" disabled>12개월 전망</button>
                                        <button class="btn btn-outline-secondary" type="button" disabled>전망 분포</button>
                                        <button class="btn btn-outline-secondary" type="button" disabled>전망치 추이</button>
                                    </div>
                                </div>
                                <div class="outlook-body">
                                    <canvas id="outlookChart"></canvas>
                                </div>
                            </section>

                            <div class="lower-box p-2">
                                <div class="sub-divider" role="separator" aria-label="보조 지표 구분선"></div>
                                <div class="row g-3">
                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">매출액 구성</h3>
                                                <div class="btn-group btn-group-sm" role="group" aria-label="값 보기 전환">
                                                    <button id="mixAbsBtn" type="button" class="btn btn-outline-secondary active">절대값</button>
                                                    <button id="mixPctBtn" type="button" class="btn btn-outline-secondary">비율화</button>
                                                </div>
                                            </div>
                                            <div class="mini-card-body"><canvas id="salesMixChart"></canvas></div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">이익률</h3>
                                            </div>
                                            <div class="mini-card-body"><canvas id="profitRateChart"></canvas></div>
                                        </section>
                                    </div>

                                    <div class="col-12 col-lg-4">
                                        <section class="mini-card">
                                            <div class="mini-card-header">
                                                <h3 class="mini-card-title mb-0">이익성장률 (YoY)</h3>
                                            </div>
                                            <div class="mini-card-body"><canvas id="growthChart"></canvas></div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<footer>© <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}">2025</span> 재무 대시보드</footer>
<div class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Inline App Script -->
<script th:inline="javascript">
    /* ===== Bootstrap Tooltip ===== */
    (function(){
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el){ new bootstrap.Tooltip(el); });
    })();

    /* ===== Zoom plugin: register once (guarded) ===== */
    (function(){
        if(!window.Chart) return;
        const zp = window.ChartZoom || window["chartjs-plugin-zoom"];
        if (!zp) return;
        const already = Chart.registry?.plugins?.get?.('zoom') || Chart.registry?.plugins?.get?.('chartjs-plugin-zoom');
        if (!already) { try { Chart.register(zp); } catch(e){} }
    })();

    /* ===== Data from server (with fallbacks) ===== */
    const YEARS = /*[[${years}]]*/ ["FY2021","FY2022","FY2023","FY2024","FY2025"];
    const CANDLES = /*[[${candles}]]*/ [
        {time:'2024-06-10',open:22150,high:22400,low:22000,close:22280},
        {time:'2024-06-11',open:22280,high:22550,low:22200,close:22490},
        {time:'2024-06-12',open:22490,high:22620,low:22350,close:22580},
        {time:'2024-06-13',open:22580,high:22650,low:22380,close:22440},
        {time:'2024-06-14',open:22440,high:22600,low:22300,close:22520},
        {time:'2024-06-17',open:22520,high:22750,low:22450,close:22720},
        {time:'2024-06-18',open:22720,high:22800,low:22580,close:22610},
        {time:'2024-06-19',open:22610,high:22840,low:22590,close:22790},
        {time:'2024-06-20',open:22790,high:22950,low:22700,close:22910},
        {time:'2024-06-21',open:22910,high:22980,low:22680,close:22730},
        {time:'2024-06-24',open:22730,high:22820,low:22550,close:22600},
        {time:'2024-06-25',open:22600,high:22750,low:22480,close:22510},
        {time:'2024-06-26',open:22510,high:22690,low:22450,close:22640},
        {time:'2024-06-27',open:22640,high:22820,low:22620,close:22770},
        {time:'2024-06-28',open:22770,high:22920,low:22700,close:22860},
        {time:'2024-07-01',open:22860,high:23100,low:22780,close:23040},
        {time:'2024-07-02',open:23040,high:23150,low:22880,close:22990},
        {time:'2024-07-03',open:22990,high:23120,low:22900,close:23060},
        {time:'2024-07-04',open:23060,high:23130,low:22850,close:22920},
        {time:'2024-07-05',open:22920,high:23010,low:22740,close:22810},
        {time:'2024-07-08',open:22810,high:22890,low:22580,close:22640},
        {time:'2024-07-09',open:22640,high:22780,low:22530,close:22690},
        {time:'2024-07-10',open:22690,high:22950,low:22640,close:22910},
        {time:'2024-07-11',open:22910,high:23060,low:22820,close:23010},
        {time:'2024-07-12',open:23010,high:23120,low:22920,close:23090},
        {time:'2024-07-15',open:23090,high:23220,low:23010,close:23170},
        {time:'2024-07-16',open:23170,high:23240,low:23020,close:23060},
        {time:'2024-07-17',open:23060,high:23130,low:22920,close:22960},
        {time:'2024-07-18',open:22960,high:23010,low:22800,close:22840},
        {time:'2024-07-19',open:22840,high:22960,low:22710,close:22930},
        {time:'2024-07-22',open:22930,high:23100,low:22850,close:23050},
        {time:'2024-07-23',open:23050,high:23200,low:22980,close:23120},
        {time:'2024-07-24',open:23120,high:23220,low:23010,close:23040},
        {time:'2024-07-25',open:23040,high:23190,low:22950,close:22980},
        {time:'2024-07-26',open:22980,high:23070,low:22800,close:22840},
        {time:'2024-07-29',open:22840,high:23020,low:22790,close:22970},
        {time:'2024-07-30',open:22970,high:23110,low:22900,close:23080},
        {time:'2024-07-31',open:23080,high:23250,low:23010,close:23210},
        {time:'2024-08-01',open:23210,high:23300,low:23020,close:23110},
        {time:'2024-08-02',open:23110,high:23220,low:22950,close:23020}
    ];
    const FACTOR = /*[[${factorScores}]]*/ [70,55,90,40,85,60];

    /* ===== Candlestick (Lightweight) + Outlook (Chart.js) ===== */
    (function(){
        const el=document.getElementById('custom_candle_chart');
        if(!window.LightweightCharts || !el){ return; }
        const chart=LightweightCharts.createChart(el,{
            width:el.clientWidth,height:el.clientHeight,
            layout:{background:{type:'solid',color:'#fff'},textColor:'#333'},
            grid:{vertLines:{color:'#eee'},horzLines:{color:'#eee'}},
            rightPriceScale:{visible:true},timeScale:{borderColor:'#eee',timeVisible:true}
        });
        chart.addCandlestickSeries({upColor:'#26a69a',downColor:'#ef5350',wickUpColor:'#26a69a',wickDownColor:'#ef5350'}).setData(CANDLES);
        chart.timeScale().fitContent();

        const ro = new ResizeObserver(entries=>{
            const {width, height} = entries[0].contentRect;
            chart.resize(Math.max(50, Math.floor(width)), Math.max(100, Math.floor(height)));
        });
        ro.observe(el);
        window.addEventListener('resize',()=>chart.resize(el.clientWidth,el.clientHeight));
        requestAnimationFrame(()=>chart.resize(el.clientWidth,el.clientHeight));

        const profitBtn = document.querySelector('[data-bs-target="#main"]');
        profitBtn?.addEventListener('shown.bs.tab',()=>{
            chart.resize(el.clientWidth,el.clientHeight);
            chart.timeScale().fitContent();
            requestAnimationFrame(()=> window._outlookChart?.resize?.());
        });

        const canvas = document.getElementById('outlookChart');
        if (!canvas) return;
        const outlookCtx = canvas.getContext('2d'); if(!outlookCtx) return;
        const nf = new Intl.NumberFormat('ko-KR');

        const lastClose = CANDLES[CANDLES.length-1].close;
        const target = { max: 36000, avg: 29875, min: 21000 };
        const history = CANDLES.map(d=>d.close);
        const labels  = CANDLES.map(d=>d.time).concat(['12개월 후']);
        const histData = history.concat([null]);
        const projBase = new Array(history.length-1).fill(null);
        const projMax  = projBase.concat([lastClose, target.max]);
        const projAvg  = projBase.concat([lastClose, target.avg]);
        const projMin  = projBase.concat([lastClose, target.min]);

        const allVals = history.concat([target.min, target.max]);
        const yMin = Math.min(...allVals);
        const yMax = Math.max(...allVals);
        const pad  = Math.max(100, (yMax - yMin) * 0.1);

        const outlookLabel = {
            id:'outlookLabel',
            afterDatasetsDraw(chart){
                const {ctx, scales, chartArea} = chart;
                const x = scales?.x, y = scales?.y;
                if (!x || !y || !chartArea) return;
                const {top, bottom} = chartArea;
                const endIndex = labels.length-1;
                ctx.save();

                function roundRect(ctx,x,y,w,h,r){
                    ctx.beginPath();
                    ctx.moveTo(x+r,y);
                    ctx.arcTo(x+w,y,x+w,y+h,r);
                    ctx.arcTo(x+w,y+h,x,y+h,r);
                    ctx.arcTo(x,y+h,x,y,r);
                    ctx.arcTo(x,y,x+w,y,r);
                    ctx.closePath();
                }
                function drawTag(yVal, text, color){
                    const xEnd = x.getPixelForValue(endIndex);
                    const yEnd = y.getPixelForValue(yVal);
                    const padX=8; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
                    const metrics = ctx.measureText(text); const boxW=metrics.width+padX*2, boxH=22;
                    const rx=6; const bx = Math.min(chart.width - boxW - 4, xEnd + 6);
                    const by = Math.min(Math.max(yEnd - boxH/2, top + 2), bottom - boxH - 2);
                    ctx.fillStyle = '#fff'; ctx.strokeStyle = color; ctx.lineWidth=1.2;
                    roundRect(ctx, bx, by, boxW, boxH, rx); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = color; ctx.fillText(text, bx+padX, by+boxH/1.5);
                }
                const p = (v)=>{ const diff=v-lastClose; const sign = diff>0? '+':'-'; return `${diff===0?'±':sign}${Math.abs(diff/lastClose*100).toFixed(2)}%  ₩${nf.format(v)}`; };
                drawTag(target.max, `최고 ${p(target.max)}`, '#198754');
                drawTag(target.avg, `평균 ${p(target.avg)}`, '#198754');
                drawTag(target.min, `최저 ${p(target.min)}`, '#dc3545');

                const xNow = x.getPixelForValue(labels.length-2);
                const yNow = y.getPixelForValue(lastClose);
                ctx.fillStyle = '#212529'; ctx.beginPath(); ctx.arc(xNow, yNow, 4, 0, Math.PI*2); ctx.fill();
                const nowText = `현재가 ₩${nf.format(lastClose)}`;
                const m = ctx.measureText(nowText); const w=m.width + 16, h=20; const rx=6;
                const nx = Math.max(Math.min(xNow - w - 8, chart.width - w - 4), 8);
                const ny = Math.min(Math.max(yNow - h/2, top + 2), bottom - h - 2);
                ctx.fillStyle='#fff'; ctx.strokeStyle='#6c757d'; ctx.lineWidth=1; roundRect(ctx,nx,ny,w,h,rx); ctx.fill(); ctx.stroke();
                ctx.fillStyle='#6c757d'; ctx.fillText(nowText, nx+8, ny+h/1.5);
                ctx.restore();
            }
        };

        const grad = outlookCtx.createLinearGradient(0,0,0,280);
        grad.addColorStop(0,'rgba(43,47,54,0.15)');
        grad.addColorStop(1,'rgba(43,47,54,0.00)');

        window._outlookChart = new Chart(outlookCtx, {
            plugins: [outlookLabel],
            type:'line',
            data:{ labels, datasets:[
                    { label:'과거', data: histData, borderWidth:1.5, pointRadius:0, tension:.25, borderColor:'#2b2f36', fill:true, backgroundColor:grad },
                    { label:'최고', data: projMax, borderColor:'#198754', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#198754', tension:.15, spanGaps:true },
                    { label:'평균', data: projAvg, borderColor:'#20c997', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#20c997', tension:.15, spanGaps:true },
                    { label:'최저', data: projMin, borderColor:'#dc3545', borderDash:[6,6], pointRadius:(c)=> (c.dataIndex >= labels.length-2 ? 3 : 0), pointBackgroundColor:'#dc3545', tension:.15, spanGaps:true }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                interaction:{ intersect:false, mode:'nearest' },
                plugins:{
                    legend:{display:false},
                    tooltip:{ enabled:true, callbacks:{ label:(c)=> '₩'+nf.format(c.parsed.y) } },
                    zoom:{ pan:{enabled:true,mode:'x'}, zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' } }
                },
                layout:{ padding:{ right: 160 } },
                scales:{
                    x:{ grid:{display:false}, ticks:{ maxRotation:0, autoSkip:true } },
                    y:{ min: yMin - pad, max: yMax + pad, ticks:{ callback:v=>'₩'+nf.format(v) } }
                }
            }
        });
    })();

    /* ===== Price header dynamic badges ===== */
    (function(){
        const nowEl=document.getElementById('price-now');
        const pctEl=document.getElementById('price-change-pct');
        const absEl=document.getElementById('price-change-abs');
        if(!nowEl||!pctEl||!absEl||!Array.isArray(CANDLES)||CANDLES.length<2) return;
        const last=CANDLES[CANDLES.length-1].close;
        const prev=CANDLES[CANDLES.length-2].close;
        const diff=last-prev;
        const pct=prev? (diff/prev*100):0;
        const nf=new Intl.NumberFormat('ko-KR');
        const sign= diff>0? '▲' : diff<0? '▼' : '—';
        const dir = diff>0? 'up' : diff<0? 'down' : 'neutral';
        nowEl.textContent=nf.format(last);
        pctEl.textContent=`${sign} ${Math.abs(pct).toFixed(2)}%`;
        absEl.textContent=`${sign} ₩${nf.format(Math.abs(diff))}`;
        [pctEl,absEl].forEach(el=>{ el.classList.remove('up','down','neutral'); el.classList.add(dir); });
    })();

    /* ===== Ratio line chart & table interactions ===== */
    (function(){
        const ctx=document.getElementById('stockChart')?.getContext('2d'); if(!ctx) return;
        const nf = new Intl.NumberFormat('ko-KR');

        window._ratioChart=new Chart(ctx,{
            type:'line',
            data:{labels:YEARS,datasets:[]},
            options:{
                responsive:true,maintainAspectRatio:false,
                animation: { duration: 250 },
                plugins:{
                    legend:{display:true},tooltip:{enabled:true},
                    zoom:{pan:{enabled:true,mode:'x'},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}}
                },
                scales:{x:{title:{display:true,text:'회계연도'}},y:{position:'right',title:{display:true,text:'값 (%)'},beginAtZero:true,ticks:{callback:v=>v+'%'}}}
            }
        });

        document.querySelector('[data-bs-target="#ratio"]')?.addEventListener('shown.bs.tab',()=>{ _ratioChart.resize(); });

        const STORAGE={yearRange:'ratioYearRange', selected:'ratioSelectedMetrics'};
        const randColor=()=>`rgb(${~~(Math.random()*255)},${~~(Math.random()*255)},${~~(Math.random()*255)})`;
        const toast=(msg)=>{
            const tc=document.querySelector('.toast-container');
            const t=document.createElement('div');
            t.className='toast align-items-center text-bg-primary border-0 show';
            t.innerHTML=`<div class='d-flex'><div class='toast-body'>${msg}</div><button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
            tc.appendChild(t);
            setTimeout(()=>{t.classList.replace('show','hide');setTimeout(()=>t.remove(),300);},2000);
        };
        window.clearAll=()=>{_ratioChart.data.datasets=[];_ratioChart.update();localStorage.removeItem(STORAGE.selected);toast('모든 지표 제거');};

        function getLabel(row){
            const total = row.cells.length;
            const hasGroup = (total === YEARS.length + 2);
            const labelCell = hasGroup ? row.cells[1] : row.cells[0];
            return (labelCell?.textContent || '').trim() || '지표';
        }
        function getValues(row){
            const values=[]; const base=row.cells.length - YEARS.length;
            for(let i=base;i<row.cells.length;i++){
                const raw=row.cells[i].textContent.replace('%','').trim();
                const num=parseFloat(raw); values.push(isNaN(num)?null:num);
            }
            return values;
        }
        function addDataset(label, data){
            _ratioChart.data.datasets.push({label, data, borderColor:randColor(), backgroundColor:'rgba(0,0,0,0.08)', pointRadius:3, tension:.3});
            _ratioChart.update();
        }
        function removeDataset(label){
            const idx=_ratioChart.data.datasets.findIndex(d=>d.label===label);
            if(idx!==-1){ _ratioChart.data.datasets.splice(idx,1); _ratioChart.update(); }
        }
        function saveSelection(){ const labels=_ratioChart.data.datasets.map(d=>d.label); localStorage.setItem(STORAGE.selected, JSON.stringify(labels)); }
        function restoreSelection(){
            const raw=localStorage.getItem(STORAGE.selected); if(!raw) return;
            const want=new Set(JSON.parse(raw));
            document.querySelectorAll('#ratioTable tbody tr').forEach(row=>{
                const label=getLabel(row); if(want.has(label)) addDataset(label, getValues(row));
            });
        }

        document.querySelectorAll('#ratioTable tbody tr').forEach((row)=>{
            row.addEventListener('click',()=>{
                const label=getLabel(row);
                const exists=_ratioChart.data.datasets.some(d=>d.label===label);
                if(exists){ removeDataset(label); toast(`${label} 제거`); }
                else{
                    if(_ratioChart.data.datasets.length>=5){ toast('최대 5개 표시'); return; }
                    addDataset(label, getValues(row)); toast(`${label} 추가`);
                }
                saveSelection();
            });
        });

        const yearSel=document.getElementById('yearRange');
        if(yearSel){
            const saved=localStorage.getItem(STORAGE.yearRange); if(saved){ yearSel.value=saved; }
            function applyRange(){
                const keep=parseInt(yearSel.value,10);
                _ratioChart.data.labels = YEARS.slice(-keep);
                _ratioChart.data.datasets.forEach(ds=>{ ds.data = ds.data.slice(-keep); });
                _ratioChart.update();
                localStorage.setItem(STORAGE.yearRange, yearSel.value);
            }
            yearSel.addEventListener('change', applyRange);
            applyRange();
        }

        document.getElementById('btnExportCsv')?.addEventListener('click',function(){
            const table=document.getElementById('ratioTable'); let csv='';
            for(const row of table.rows){
                const cells=[...row.cells].map(td=>{
                    const t = td.innerText.replace(/\n/g,' ').trim().replace(/"/g,'""');
                    return `"${t}"`;
                });
                csv += cells.join(',') + '\n';
            }
            const blob=new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
            const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ratio_table.csv'; a.click(); URL.revokeObjectURL(url);
        });

        document.getElementById('btnExportPng')?.addEventListener('click',function(){
            const url=_ratioChart.toBase64Image('image/png',1);
            const a=document.createElement('a'); a.href=url; a.download='ratio_chart.png'; a.click();
        });

        document.getElementById('btnResetZoom')?.addEventListener('click',function(){ if(_ratioChart.resetZoom){ _ratioChart.resetZoom(); } });

        restoreSelection();
    })();

    /* ===== Radar Chart for factor ===== */
    (function(){
        const canvas = document.getElementById('factorChart'); if (!canvas) return;
        const ctx = canvas.getContext('2d'); if (!ctx) return;

        new Chart(ctx,{
            type:'radar',
            data:{
                labels:['변동성','밸류','사이즈','모멘텀','베타','전망치'],
                datasets:[{
                    label:'팩터 점수',
                    data:FACTOR,
                    backgroundColor:'rgba(54,162,235,0.2)',
                    borderColor:'rgba(54,162,235,1)',
                    pointBackgroundColor:'rgba(54,162,235,1)',
                    pointRadius:3,
                    fill:true,
                    tension:0.25
                }]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{ legend:{display:false} },
                scales:{
                    r:{ beginAtZero:true, min:0, max:100, ticks:{stepSize:20}, angleLines:{color:'#eee'}, grid:{color:'#ddd'} }
                }
            }
        });
    })();

    /* ===== Support Charts (Sales Mix / Profit Rate / Growth) ===== */
    (function(){
        const nf = new Intl.NumberFormat('ko-KR');
        const years=['2022','2023','2024'];

        function toPctStacks(stacks){
            const totals = years.map((_,i)=> stacks.reduce((s,st)=>s+(st.data[i]||0),0));
            return stacks.map(st=>({label:st.label, data:st.data.map((v,i)=> totals[i]? +(v/totals[i]*100).toFixed(2):0)}));
        }

        const mixDataAbs={
            labels: years,
            stacks: [
                {label:'이자비용', data:[200,260,320]},
                {label:'대손충당금', data:[300,420,520]},
                {label:'이자외비용', data:[180,210,250]},
                {label:'세전당기손익', data:[280,460,620]},
                {label:'이자수익+이자외수익', data:[700,980,1200]}
            ],
            line:{label:'순이자마진', data:[2.3,2.1,2.4]}
        };
        const mixDataPct = { labels:years, stacks: toPctStacks(mixDataAbs.stacks), line: mixDataAbs.line };

        const stackedBarOpts=(isPct=false)=>({
            responsive:true, maintainAspectRatio:false,
            scales:{
                x:{ stacked:true },
                y:{ stacked:true, position:'left', beginAtZero:true,
                    ticks:{ callback:v=> isPct? v+'%': '₩'+nf.format(v) } },
                y2:{ position:'right', beginAtZero:true, min:0, max: (isPct? 100: 3),
                    grid:{ drawOnChartArea:false }, ticks:{ callback:v=> v+'%' } }
            },
            plugins:{ legend:{position:'bottom'} }
        });

        const mixCtx=document.getElementById('salesMixChart')?.getContext('2d'); if(!mixCtx) return;
        let mixMode='abs';
        const mixChart=new Chart(mixCtx,{
            type:'bar',
            data:{ labels:mixDataAbs.labels, datasets:[
                    ...mixDataAbs.stacks.map(st=>({ type:'bar',label:st.label,data:st.data,stack:'stack',order:2 })),
                    { type:'line', label:mixDataAbs.line.label, data:mixDataAbs.line.data, yAxisID:'y2', order:1, tension:.3, pointRadius:2 }
                ]},
            options: stackedBarOpts(false)
        });
        function switchMix(mode){
            if(mixMode===mode) return; mixMode=mode;
            const isPct = mode==='pct';
            const use = isPct? mixDataPct : mixDataAbs;
            mixChart.data.labels = use.labels;
            for(let i=0;i<use.stacks.length;i++){
                mixChart.data.datasets[i].data = use.stacks[i].data;
                mixChart.data.datasets[i].type='bar';
                mixChart.data.datasets[i].yAxisID='y';
                mixChart.data.datasets[i].stack='stack';
            }
            mixChart.data.datasets[use.stacks.length] = {
                ...mixChart.data.datasets[use.stacks.length],
                type:'line', data: use.line.data, yAxisID:'y2', order:1
            };
            mixChart.options = stackedBarOpts(isPct);
            mixChart.update();
            document.getElementById('mixAbsBtn').classList.toggle('active', !isPct);
            document.getElementById('mixPctBtn').classList.toggle('active', isPct);
        }
        document.getElementById('mixAbsBtn')?.addEventListener('click',()=>switchMix('abs'));
        document.getElementById('mixPctBtn')?.addEventListener('click',()=>switchMix('pct'));

        const prCtx=document.getElementById('profitRateChart')?.getContext('2d'); if(!prCtx) return;
        new Chart(prCtx,{
            type:'bar',
            data:{ labels:years, datasets:[
                    { type:'bar', label:'이자수익+이자외수익', data:[1200,1500,1700], order:2 },
                    { type:'line', label:'세전손익률', data:[21.8,18.9,20.5], yAxisID:'y2', order:1, tension:.3, pointRadius:2 },
                    { type:'line', label:'순이익률', data:[17.2,15.1,16.4], yAxisID:'y2', order:1, tension:.3, pointRadius:2 }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{
                    y:{ beginAtZero:true, ticks:{ callback:v=>'₩'+new Intl.NumberFormat('ko-KR').format(v) } },
                    y2:{ position:'right', beginAtZero:true, min:0, max:25, grid:{ drawOnChartArea:false }, ticks:{ callback:v=>v+'%' } }
                },
                plugins:{ legend:{position:'bottom'} }
            }
        });

        const grCtx=document.getElementById('growthChart')?.getContext('2d'); if(!grCtx) return;
        new Chart(grCtx,{
            type:'line',
            data:{ labels:years, datasets:[
                    { label:'순이자수익성장률', data:[50,20,24], tension:.3, pointRadius:2 },
                    { label:'대손충당금 차감 후 순이자수익', data:[40,18,22], tension:.3, pointRadius:2 },
                    { label:'세전당기손익성장률', data:[35,14,26], tension:.3, pointRadius:2 },
                    { label:'순이익성장률', data:[32,15,23], tension:.3, pointRadius:2 }
                ]},
            options:{
                responsive:true, maintainAspectRatio:false,
                scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>v+'%' } } },
                plugins:{ legend:{position:'bottom'} }
            }
        });
    })();

    /* ===== Profit/Risk Tab ===== */
    (function(){
        // 서버 데이터 (Thymeleaf 바인딩; 폴백)
        const RETURNS = /*[[${monthlyReturns}]]*/ [-1.2, 0.8, 1.1, -0.6, 2.2, 0.3, -1.4, 1.9, 0.5, -0.9, 1.3, 0.7,
            0.6, -0.4, 1.0, 0.2, -0.7, 1.5, -0.3, 0.9, 0.4, -1.1, 1.2, 0.1];
        const PNL_AMOUNT = /*[[${pnlAmount}]]*/ [50, 65, 80, 75, 100, 103, 88, 110, 116, 108, 123, 128,
            131, 129, 140, 145, 138, 158, 153, 166, 170, 160, 178, 180];
        const DECOMP = /*[[${pnlDecomposition}]]*/ {
            labels: ['2022','2023','2024'],
            stacks: [
                {label:'이자수익', data:[520, 640, 780]},
                {label:'이자비용', data:[-200, -260, -320]},
                {label:'이자외수익', data:[180, 210, 250]},
                {label:'이자외비용', data:[-120, -140, -160]},
                {label:'대손충당금', data:[-140, -220, -260]}
            ],
            net: {label:'세전당기손익', data:[240, 230, 290]}
        };

        const nf = new Intl.NumberFormat('ko-KR');

        function stdev(arr){
            if(!arr.length) return 0;
            const m = arr.reduce((a,b)=>a+b,0)/arr.length;
            const v = arr.reduce((s,x)=> s + Math.pow(x-m,2), 0) / (arr.length-1 || 1);
            return Math.sqrt(v);
        }
        function annualizeVol(monthlyStd){ return monthlyStd * Math.sqrt(12); }
        function maxDrawdown(series){ // series: 누적지표(정규화) 시퀀스
            let peak = -Infinity, mdd = 0;
            for(const x of series){ peak = Math.max(peak, x); mdd = Math.min(mdd, (x - peak) / peak); }
            return mdd; // 음수
        }
        function toPctStacks(stacks){
            const n = Math.max(...stacks.map(s=> s.data.length));
            const totals = Array.from({length:n}, (_,i)=> stacks.reduce((s,st)=> s + (st.data[i]||0),0));
            return stacks.map(st=> ({ label: st.label, data: st.data.map((v,i)=> totals[i] ? +(v/totals[i]*100).toFixed(2) : 0) }));
        }

        let pnlCurveChart=null, pnlDecompChart=null;
        let pnlMode='cum';
        let pnlRange='12';
        let decompMode='abs';

        const $profitTabBtn = document.querySelector('[data-bs-target="#profit"]');

        function buildOrUpdateAll(){
            const lastN = pnlRange==='all' ? RETURNS.length : Math.min(+pnlRange, RETURNS.length);
            const ret = RETURNS.slice(-lastN);
            const pnlAmt = PNL_AMOUNT.slice(-lastN);

            // 기간/누적 금액
            const labels = Array.from({length:lastN}, (_,i)=> `M${RETURNS.length-lastN+i+1}`);
            const base = (pnlMode==='cum')
                ? pnlAmt
                : pnlAmt.map((v,i,arr)=> i===0 ? 0 : v - arr[i-1]);

            // 드로우다운 (누적기준 정규화 + 0 가드)
            const base0 = Math.max(1e-9, Math.abs(pnlAmt[0] ?? 0)); // 0 가드
            const cumForDD = pnlAmt.map(v => v / base0);
            const mdd = maxDrawdown(cumForDD);
            const drawdownPct = cumForDD.map((v,i)=>{
                const peak = Math.max(...cumForDD.slice(0,i+1));
                return (v-peak)/peak * 100;
            }).slice(-lastN);

            const pnlCtx = document.getElementById('pnlCurveChart')?.getContext('2d');
            if(!pnlCtx) return;
            if(!pnlCurveChart){
                pnlCurveChart = new Chart(pnlCtx,{
                    type:'line',
                    data:{ labels, datasets:[
                            { type:'line', label: (pnlMode==='cum'?'누적 손익(만원)':'기간 손익(만원)'),
                                data: base, yAxisID:'y', tension:.25, pointRadius:0, borderWidth:1.5, fill:false },
                            { type:'line', label:'드로우다운(%)',
                                data: drawdownPct, yAxisID:'y2', tension:.25, pointRadius:0, borderWidth:1, borderDash:[4,4] }
                        ]},
                    options:{
                        responsive:true, maintainAspectRatio:false,
                        interaction:{intersect:false, mode:'index'},
                        plugins:{ legend:{position:'bottom'},
                            zoom:{ pan:{enabled:true,mode:'x'}, zoom:{ wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'} } },
                        scales:{
                            y:{ position:'left', beginAtZero:false, ticks:{ callback:v=> '₩'+nf.format(v*10000) } },
                            y2:{ position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, ticks:{ callback:v=> v+'%' } }
                        }
                    }
                });
            }else{
                pnlCurveChart.data.labels = labels;
                pnlCurveChart.data.datasets[0].label = (pnlMode==='cum'?'누적 손익(만원)':'기간 손익(만원)');
                pnlCurveChart.data.datasets[0].data = base;
                pnlCurveChart.data.datasets[1].data = drawdownPct;
                pnlCurveChart.update();
            }

            // 손익 분해
            const useStacks = (decompMode==='pct') ? toPctStacks(DECOMP.stacks) : DECOMP.stacks;
            const yTick = (decompMode==='pct') ? (v=> v+'%') : (v=> '₩'+nf.format(v*10000));
            const decompCtx=document.getElementById('pnlDecompChart')?.getContext('2d');
            if(decompCtx){
                if(!pnlDecompChart){
                    pnlDecompChart = new Chart(decompCtx,{
                        type:'bar',
                        data:{ labels: DECOMP.labels,
                            datasets:[
                                ...useStacks.map(s=> ({type:'bar', label:s.label, data:s.data, stack:'stack', order:2})),
                                { type:'line', label:DECOMP.net.label, data:DECOMP.net.data, yAxisID:'y2', order:1, pointRadius:2, tension:.25 }
                            ]},
                        options:{
                            responsive:true, maintainAspectRatio:false,
                            scales:{
                                x:{ stacked:true },
                                y:{ stacked:true, beginAtZero:false, ticks:{ callback:yTick } },
                                y2:{ position:'right', grid:{drawOnChartArea:false}, ticks:{ callback:v=> '₩'+nf.format(v*10000) } }
                            },
                            plugins:{ legend:{position:'bottom'} }
                        }
                    });
                }else{
                    for(let i=0;i<useStacks.length;i++){
                        pnlDecompChart.data.datasets[i].data = useStacks[i].data;
                        pnlDecompChart.data.datasets[i].type='bar';
                        pnlDecompChart.data.datasets[i].yAxisID='y';
                        pnlDecompChart.data.datasets[i].stack='stack';
                    }
                    pnlDecompChart.options.scales.y.ticks.callback = yTick;
                    pnlDecompChart.update();
                }
            }

            // ===== KPI 산출 =====
            const meanMonthly = ret.reduce((a,b)=>a+b,0) / (ret.length || 1); // %
            const mStd = stdev(ret);                  // 월간 표준편차 (%)
            const annRetPct = ((1 + meanMonthly/100) ** 12 - 1) * 100; // %
            const annVolPct = annualizeVol(mStd);    // % (단위 통일)
            const sharpe = annVolPct ? (annRetPct / annVolPct) : 0; // Rf=0 가정
            const winratePct = (ret.filter(x=>x>0).length / (ret.length||1) * 100);

            const var95 = (mStd*1.65);               // 월간 VaR(%) 근사
            const mddPct = Math.abs(mdd*100);

            const $ = (id)=>document.getElementById(id);
            $('kpiSharpe').textContent  = sharpe.toFixed(2);
            $('kpiWinrate').textContent = winratePct.toFixed(1)+'%';
            $('kpiVol').textContent     = annVolPct.toFixed(2)+'%';
            $('kpiBeta').textContent    = (/*[[${beta}]]*/ 1.00).toFixed(2);
            $('kpiVaR').textContent     = var95.toFixed(2)+'%';
            $('kpiMdd').textContent     = mddPct.toFixed(2)+'%';
        }

        // 이벤트 바인딩
        document.getElementById('pnlRange')?.addEventListener('change', (e)=>{ pnlRange=e.target.value; buildOrUpdateAll(); });
        document.getElementById('pnlModeCum')?.addEventListener('click', ()=>{
            pnlMode='cum';
            document.getElementById('pnlModeCum').classList.add('active');
            document.getElementById('pnlModePer').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('pnlModePer')?.addEventListener('click', ()=>{
            pnlMode='per';
            document.getElementById('pnlModePer').classList.add('active');
            document.getElementById('pnlModeCum').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('decompAbs')?.addEventListener('click', ()=>{
            decompMode='abs';
            document.getElementById('decompAbs').classList.add('active');
            document.getElementById('decompPct').classList.remove('active');
            buildOrUpdateAll();
        });
        document.getElementById('decompPct')?.addEventListener('click', ()=>{
            decompMode='pct';
            document.getElementById('decompPct').classList.add('active');
            document.getElementById('decompAbs').classList.remove('active');
            buildOrUpdateAll();
        });

        document.getElementById('pnlExportPng')?.addEventListener('click', ()=>{
            if(!pnlCurveChart) return;
            const url = pnlCurveChart.toBase64Image('image/png',1);
            const a=document.createElement('a'); a.href=url; a.download='pnl_curve.png'; a.click();
        });
        document.getElementById('pnlResetZoom')?.addEventListener('click', ()=>{ pnlCurveChart?.resetZoom?.(); });

        // 탭 표시 시 초기화/리사이즈
        let initialized=false;
        $profitTabBtn?.addEventListener('shown.bs.tab', ()=>{
            if(!initialized){ initialized=true; buildOrUpdateAll(); }
            else{
                pnlCurveChart?.resize?.();
                pnlDecompChart?.resize?.();
            }
        });
    })();

    /* ===== Strategy buttons & GenAI output (single source of truth) ===== */
    (function(){
        const $prompt    = document.getElementById('stratPrompt');
        const $pnlRange  = document.getElementById('pnlRange');
        const $modePer   = document.getElementById('pnlModePer');
        const $output    = document.getElementById('genaiOutput');

        // ▼ 신규: 옵션 엘리먼트
        const $kinds     = document.getElementById('stratKinds');
        const $risk      = document.getElementById('stratRisk');
        const $optLev    = document.getElementById('optLeverage');
        const $optHedge  = document.getElementById('optHedge');

        function setOutputText(text){ if($output) $output.textContent = text; }
        function appendOutputText(text){ if($output) $output.textContent += text; }

        // ▼ 전략 프리셋마다 권장 제약/설명을 매핑 (백엔드가 활용해도 됨)
        const STRATEGY_TEMPLATES = {
            barbell: {
                label: '바벨',
                note: '초저위험/초고위험을 양 끝단으로 배치, 중간 위험 제거. 현금/단기채 + 고변동 섹터/팩터.',
                constraints: { midRiskAssets: 'minimize', tailRiskBudget: 'allow' }
            },
            balanced: {
                label: '균형형',
                note: '주식/채권/대체 간 균형, 자산군 상관관계 고려한 리밸런스.',
                constraints: { targetVol: '8~12%', rebalance: 'quarterly' }
            },
            aggressive: {
                label: '공격적',
                note: '고베타/모멘텀/성장 비중 확대, 변동성/낙폭 허용.',
                constraints: { maxDrawdownTarget: '20~35%', betaBias: '>1.1' }
            },
            defensive: {
                label: '방어적',
                note: '저변동/가치/퀄리티 중심, 낙폭 축소 우선.',
                constraints: { maxDrawdownTarget: '<=15%', betaBias: '<0.9' }
            },
            value:     { label:'가치',     note:'저평가·현금흐름·배당 지표 우선.', constraints:{ factorTilt:'Value' } },
            growth:    { label:'성장',     note:'매출/이익 성장률·가이던스 상향 우선.', constraints:{ factorTilt:'Growth' } },
            dividend:  { label:'배당',     note:'배당수익률·증가·지속가능성.', constraints:{ payoutPolicy:'stable' } },
            momentum:  { label:'모멘텀',   note:'가격/실적 모멘텀 동행.', constraints:{ lookback:'6~12M' } },
            quality:   { label:'퀄리티',   note:'수익성·안정성·재무건전성.', constraints:{ filter:'ROE/ROA/부채비율' } },
            riskParity:{ label:'리스크 패리티', note:'기여 변동성 균등화.', constraints:{ riskContribution:'equal' } },
            dualMomentum:{ label:'듀얼 모멘텀', note:'절대+상대 모멘텀 결합.', constraints:{ cashOnWeakness:true } },
            hedged:    { label:'헤지',     note:'선물/옵션/인버스 등 하방 방어.', constraints:{ hedgeRatio:'0~50%' } }
        };

        function getSelectedKinds(){
            if(!$kinds) return [];
            return Array.from($kinds.selectedOptions).map(o=>o.value);
        }

        // ▼ 리스크 성향별 가이드(백엔드 힌트)
        const RISK_PROFILE_HINT = {
            conservative: { targetVol:'5~8%',  maxDrawdown:'<=12%', turnover:'low' },
            moderate:     { targetVol:'8~12%', maxDrawdown:'<=20%', turnover:'mid' },
            aggressive:   { targetVol:'12~18%',maxDrawdown:'<=35%', turnover:'mid~high' }
        };

        // ▼ 사람이 읽기 좋은 “요약 프롬프트” 생성 (선택한 옵션을 자연어로 합성)
        function buildNaturalPrompt({prompt, kinds, risk, leverage, hedge, horizon, mode}){
            const kLabels = kinds.map(k=> STRATEGY_TEMPLATES[k]?.label || k).join(', ');
            const riskKo  = {conservative:'보수적', moderate:'중립', aggressive:'공격적'}[risk] || risk;

            const hints = RISK_PROFILE_HINT[risk] || {};
            const flags = [
                leverage ? '레버리지 허용' : '레버리지 미사용',
                hedge ? '헤지 사용' : '헤지 미사용',
                (mode==='per' ? '기간손익 기준' : '누적손익 기준')
            ].join(', ');

            const kindNotes = kinds
                .map(k=> STRATEGY_TEMPLATES[k]?.note)
                .filter(Boolean)
                .map(n=> `- ${n}`)
                .join('\n');

            return [
                `요청 전략: ${kLabels || '일반'} (${riskKo})`,
                `분석 구간: 최근 ${horizon==='all'?'전체':horizon+'개월'} / 표시단위: ${mode==='per'?'기간':'누적'}`,
                `옵션: ${flags}`,
                `리스크 가이드: 목표 변동성 ${hints.targetVol || '-'}, MDD ${hints.maxDrawdown || '-'}, 회전율 ${hints.turnover || '-'}`,
                kindNotes && `전략 노트:\n${kindNotes}`,
                prompt && `사용자 프롬프트: ${prompt}`
            ].filter(Boolean).join('\n');
        }

        // ▼ 백엔드로 넘길 payload
        function payload(){
            const kinds = getSelectedKinds();
            return {
                prompt: ($prompt?.value || '').trim(),
                horizon: $pnlRange?.value || '12',
                mode: ($modePer?.classList.contains('active') ? 'per' : 'cum'),
                strategy: {
                    kinds,                           // 예: ['barbell','aggressive']
                    risk: $risk?.value || 'moderate',
                    leverageAllowed: !!$optLev?.checked,
                    hedgeAllowed: !!$optHedge?.checked
                },
                // 힌트(선택): 서버가 프롬프트 엔지니어링에 쓰기 좋게 제공
                hints: {
                    riskProfile: RISK_PROFILE_HINT[$risk?.value || 'moderate'] || {},
                    templates: kinds.map(k=> STRATEGY_TEMPLATES[k] || {label:k})
                },
                // 사람이 보기에 좋은 합성 프롬프트 (서버가 바로 써도 OK)
                naturalPrompt: buildNaturalPrompt({
                    prompt: ($prompt?.value || '').trim(),
                    kinds,
                    risk: $risk?.value || 'moderate',
                    leverage: !!$optLev?.checked,
                    hedge: !!$optHedge?.checked,
                    horizon: $pnlRange?.value || '12',
                    mode: ($modePer?.classList.contains('active') ? 'per' : 'cum')
                })
            };
        }

        function fire(type){
            const detail = payload();
            document.dispatchEvent(new CustomEvent(type, { detail }));

            const title = (type==='strategy:generate' ? '전략 생성'
                : type==='strategy:riskAudit' ? '리스크 점검'
                    : '리밸런싱 제안');

            setOutputText(
                `[${title}] 요청을 전송했습니다.${detail.naturalPrompt}(백엔드 연동 시 이 영역에 생성 결과가 렌더링됩니다.)`);
        }

        document.getElementById('btnGenStrategy')?.addEventListener('click', ()=> fire('strategy:generate'));
        document.getElementById('btnRiskAudit')?.addEventListener('click', ()=> fire('strategy:riskAudit'));
        document.getElementById('btnRebalance')?.addEventListener('click', ()=> fire('strategy:rebalance'));

        document.getElementById('btnExportProfitPng')?.addEventListener('click', ()=>{
            document.getElementById('pnlExportPng')?.click();
        });
        document.getElementById('btnResetProfitZoom')?.addEventListener('click', ()=>{
            document.getElementById('pnlResetZoom')?.click();
        });

        // 결과 패널 도구
        document.getElementById('btnCopyGenai')?.addEventListener('click', async ()=>{
            try{
                await navigator.clipboard.writeText($output?.innerText || $output?.textContent || '');
                appendOutputText('\n\n(복사 완료)');
            }catch(e){
                appendOutputText('\n\n(복사 실패: 브라우저 권한을 확인하세요)');
            }
        });
        document.getElementById('btnClearGenai')?.addEventListener('click', ()=>{
            setOutputText('결과가 여기에 표시됩니다.');
        });
    })();

    // ===== Backend wiring placeholders =====
    document.addEventListener('strategy:generate', (e)=>{
        // e.detail 구조 확인
        console.log('strategy:generate payload', e.detail);

        // 예시: 서버 호출
        // fetch('/api/strategy/generate', {
        //   method:'POST',
        //   headers:{'Content-Type':'application/json'},
        //   body: JSON.stringify(e.detail)
        // }).then(r=>r.json()).then(data=>{
        //   // genaiOutput.innerHTML = sanitize(data.html);
        // });
    });

    document.addEventListener('strategy:riskAudit', (e)=>{
        console.log('strategy:riskAudit payload', e.detail);
        // TODO
    });
    document.addEventListener('strategy:rebalance', (e)=>{
        console.log('strategy:rebalance payload', e.detail);
        // TODO
    });
</script>
</body>
</html>
